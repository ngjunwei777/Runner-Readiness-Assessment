<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Runner Readiness Assessment - Gait Coach App</title>

  <!-- PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- XLSX export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --muted:#a9b4cc;
      --text:#eef3ff;
      --line:rgba(255,255,255,.10);
      --accent:#3dd6d0;
      --accent2:#7aa6ff;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --good:#4ee59b;
      --shadow: 0 10px 35px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 15% 10%, rgba(61,214,208,.18), transparent 55%),
                  radial-gradient(900px 600px at 85% 20%, rgba(122,166,255,.18), transparent 55%),
                  linear-gradient(180deg, #070b14 0%, var(--bg) 55%, #070b14 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(7,11,20,.92), rgba(7,11,20,.65));
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:18px 16px;}
    .topbar{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:#ffffff;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .logo svg{display:block}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12.5px;margin-top:2px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s ease;
    }
    button:hover{transform: translateY(-1px); background: rgba(255,255,255,.10)}
    button.primary{border-color: rgba(61,214,208,.35); background: rgba(61,214,208,.16);}
    button.danger{border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.14);}

    main{max-width:1180px;margin:0 auto;padding:18px 16px 80px;}
    .grid{display:grid;grid-template-columns: 1.3fr .7fr;gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} header{position:relative} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .card .hd h2{margin:0;font-size:14.5px}
    .pill{
      font-size:12px;color:var(--muted);
      padding:6px 10px;border:1px solid var(--line);border-radius:999px;
      background: rgba(255,255,255,.04);
    }
    .card .bd{padding:14px}

    .sectionTitle{
      margin:16px 0 10px;
      font-size:12px;
      color: var(--muted);
      letter-spacing:.14em;
      text-transform:uppercase;
    }
    .twoCol{display:grid;grid-template-columns: 1fr 1fr;gap:10px;}
    .threeCol{display:grid;grid-template-columns: 1fr 1fr 1fr;gap:10px;}
    @media (max-width: 800px){ .threeCol{grid-template-columns:1fr} }
    @media (max-width: 680px){ .twoCol{grid-template-columns:1fr} }

    input[type="text"], input[type="date"], input[type="number"], select, textarea{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(10,16,30,.65);
      color: var(--text);
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    .hr{height:1px;background:var(--line);margin:12px 0;}
    .footnote{color:var(--muted);font-size:12px;margin-top:8px;}
    .inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}

    /* Collapsible */
    details{
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    details summary{
      cursor:pointer;
      user-select:none;
      list-style:none;
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(255,255,255,.04);
      font-weight:800;
    }
    details summary::-webkit-details-marker{display:none}
    .chev{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      transition: transform .15s ease;
      color: var(--muted);
    }
    details[open] .chev{ transform: rotate(180deg); }
    .detailsBody{ padding:12px; }

    /* Tables */
    .tbl{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background: rgba(255,255,255,.03);
      min-width: 820px; /* allows horizontal scroll on phones */
    }
    .tbl th, .tbl td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      border-right:1px solid var(--line);
      vertical-align:top;
      font-size:13px;
    }
    .tbl th:last-child, .tbl td:last-child{border-right:none}
    .tbl tr:last-child td{border-bottom:none}
    .tbl thead th{
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight:600;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .metricCell{
      font-weight:800;
      width: 230px;
      min-width: 180px;
      background: rgba(255,255,255,.02);
      user-select:none;
      cursor:pointer;
    }

    /* Clickable buttons in cells */
    .toggleBtn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      width:100%;
      min-height:42px;
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      font-weight:700;
    }
    .toggleBtn:hover{background: rgba(255,255,255,.06)}
    .toggleBtn:active{transform: scale(.99)}
    .toggleBtn.on{
      border-color: rgba(61,214,208,.55);
      background: rgba(61,214,208,.14);
    }
    .toggleBtn.bad.on{
      border-color: rgba(255,107,107,.55);
      background: rgba(255,107,107,.14);
    }
    .tick{
      width:18px;height:18px;border-radius:6px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(10,16,30,.55);
      position:relative;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
      flex: 0 0 auto;
    }
    .toggleBtn.on .tick{
      border-color: rgba(61,214,208,.6);
      background: rgba(61,214,208,.18);
    }
    .toggleBtn.bad.on .tick{
      border-color: rgba(255,107,107,.6);
      background: rgba(255,107,107,.16);
    }
    .toggleBtn.on .tick::after{
      content:"";
      position:absolute;
      left:5px; top:2px;
      width:5px; height:10px;
      border-right:2px solid var(--accent);
      border-bottom:2px solid var(--accent);
      transform: rotate(40deg);
    }
    .toggleBtn.bad.on .tick::after{
      border-right-color: rgba(255,107,107,.95);
      border-bottom-color: rgba(255,107,107,.95);
    }

    /* Chips */
    .chips{display:flex; flex-wrap:wrap; gap:6px;}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-size:12px;
      line-height:1.1;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
    }
    .chip:hover{background: rgba(255,255,255,.07)}
    .chip:active{transform: scale(.99)}
    .chip.on{
      border-color: rgba(255,204,102,.45);
      background: rgba(255,204,102,.14);
    }
    .dot{width:8px;height:8px;border-radius:50%;background: rgba(255,255,255,.25)}
    .chip.on .dot{background: var(--warn)}
    .limitsHint{color: var(--muted);font-size:12px;padding:6px 0 2px;}

    /* Ankle ROM block */
    .ankleGrid{
      display:grid;
      grid-template-columns: 1fr 120px 120px;
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background: rgba(255,255,255,.03);
    }
    .ankleCell{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      border-right:1px solid var(--line);
      font-size:13px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .ankleCell:last-child{border-right:none}
    .ankleHead{
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight:600;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .ankleLabel{
      font-weight:800;
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
    }
    .glyph{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
      font-size:16px;
    }

    /* Summary */
    .kpi{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;}
    @media (max-width: 680px){ .kpi{grid-template-columns:1fr} }
    .stat{
      padding:12px;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.04);
    }
    .stat b{display:block;font-size:18px;margin-bottom:2px}
    .stat span{color:var(--muted);font-size:12px}
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      margin: 6px 6px 0 0;
      font-size:12.5px;
    }
    .dotTag{width:9px;height:9px;border-radius:50%}
    .dotTag.bad{background:var(--bad)}
    .dotTag.warn{background:var(--warn)}
    .dotTag.good{background:var(--good)}
    .summaryBox{
      padding:12px;
      border:1px dashed rgba(255,255,255,.20);
      border-radius:16px;
      background: rgba(255,255,255,.03);
      white-space: pre-wrap;
      line-height:1.35;
      font-size:13px;
    }

    /* Waiver */
    .miniRow{display:grid;grid-template-columns: 1fr 1fr;gap:10px;}
    @media (max-width: 680px){ .miniRow{grid-template-columns:1fr} }
    .warnBox{
      border:1px solid rgba(255,204,102,.35);
      background: rgba(255,204,102,.08);
      border-radius:14px;
      padding:10px;
      color: var(--text);
      font-size:12.5px;
      line-height:1.35;
    }

    /* Mobile horizontal table scrolling */
    .tableWrap{
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 16px;
    }
    .scrollHint{
      display:none;
      color: var(--muted);
      font-size: 12px;
      margin: 6px 2px 8px;
    }
    @media (max-width: 680px){
      .scrollHint{ display:block; }
    }

    footer{
      border-top:1px solid var(--line);
      background: rgba(7,11,20,.6);
      color: var(--muted);
      font-size:12px;
      padding:14px 16px;
    }
    footer .wrap{padding:0 16px}
    .copyRow{display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;align-items:center;max-width:1180px;margin:0 auto;}
    .copyRow b{color:var(--text);font-weight:700}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- Black cat silhouette (inline SVG) -->
          <svg viewBox="0 0 128 128" width="44" height="44" aria-hidden="true" focusable="false">
            <path fill="#000" d="M23 56c0-10 3-19 10-26l-3-17c-1-5 4-9 9-7l16 8c3-1 6-2 9-2h6c3 0 6 1 9 2l16-8c5-2 10 2 9 7l-3 17c7 7 10 16 10 26 0 26-20 44-47 44H70c-27 0-47-18-47-44z"/>
            <path fill="#000" d="M38 30l-2-12 10 5c-3 2-6 4-8 7zM90 30c-2-3-5-5-8-7l10-5-2 12z"/>
            <path fill="#000" d="M104 90c10 0 18 7 18 16 0 8-6 14-15 14-6 0-9-3-12-7 7 1 12-2 12-7 0-5-5-9-11-9-4 0-7 1-10 3l-6-10c6-4 13-6 24-6z"/>
          </svg>
        </div>
        <div>
          <h1>Runner Readiness Assessment</h1>
          <div class="sub">Assessment + Training History Waiver • Export PDF + XLSX</div>
        </div>
      </div>
      <div class="actions">
        <button class="primary" id="btnSave">Save</button>
        <button id="btnLoad">Load</button>
        <button class="primary" id="btnXlsx">Download XLSX</button>
        <button class="primary" id="btnPdf">Download PDF</button>
        <button id="btnPrint">Print</button>
        <button class="danger" id="btnReset">Reset</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <div class="hd">
        <h2>Assessment Form</h2>
        <span class="pill" id="autosavePill">Autosave: Off</span>
      </div>
      <div class="bd">

        <div class="sectionTitle">Client details</div>
        <div class="twoCol">
          <div>
            <label class="footnote">Client Name</label>
            <input type="text" id="clientName" placeholder="e.g., Alex Tan" />
          </div>
          <div>
            <label class="footnote">Assessment Date</label>
            <input type="date" id="assessDate" />
          </div>
        </div>

        <!-- Collapsible Training History / Waiver -->
        <div class="sectionTitle">Training History & Waiver</div>
        <details id="waiverDetails">
          <summary>
            <span>Open / Close: Training History, Goals & Medical Waiver</span>
            <span class="chev">▾</span>
          </summary>
          <div class="detailsBody">

            <div class="sectionTitle" style="margin-top:0;">Training history</div>
            <div class="threeCol">
              <div>
                <label class="footnote">Years of running experience</label>
                <input type="number" id="yearsRunning" min="0" step="0.5" placeholder="e.g., 3" />
              </div>
              <div>
                <label class="footnote">Runs per week</label>
                <input type="number" id="runsPerWeek" min="0" step="1" placeholder="e.g., 4" />
              </div>
              <div>
                <label class="footnote">Mileage per week (km)</label>
                <input type="number" id="mileagePerWeek" min="0" step="1" placeholder="e.g., 25" />
              </div>
            </div>

            <div class="hr"></div>

            <div class="sectionTitle" style="margin-top:0;">Goals</div>
            <textarea id="runningGoals" placeholder="E.g., 10K PB, return-to-run, marathon build, run pain-free..."></textarea>

            <div class="hr"></div>

            <div class="sectionTitle" style="margin-top:0;">Musculoskeletal injury history</div>
            <div class="miniRow">
              <div>
                <label class="footnote">Past / current musculoskeletal injuries</label>
                <textarea id="mskHistory" placeholder="Location, side, diagnosis, onset, rehab completed, current symptoms..."></textarea>
              </div>
              <div>
                <label class="footnote">Stress fracture history</label>
                <select id="stressFracture">
                  <option value="">Select…</option>
                  <option value="No">No</option>
                  <option value="Yes - past">Yes (past)</option>
                  <option value="Yes - current">Yes (current)</option>
                  <option value="Unsure">Unsure</option>
                </select>

                <div style="height:10px"></div>

                <label class="footnote">High-risk / needs medical clearance?</label>
                <select id="medicalClearance">
                  <option value="">Select…</option>
                  <option value="Not required">Not required</option>
                  <option value="Required (pending)">Required (pending)</option>
                  <option value="Cleared by doctor">Cleared by doctor</option>
                  <option value="Unsure">Unsure</option>
                </select>
              </div>
            </div>

            <div class="hr"></div>

            <div class="sectionTitle" style="margin-top:0;">Waiver acknowledgment</div>
            <div class="warnBox">
              This screening is not a medical diagnosis. If you are at high risk, have unresolved pain, or are advised to obtain medical clearance,
              consult a qualified healthcare professional before starting or progressing exercise. Coaching guidance is based on information disclosed.
            </div>

            <div style="height:10px"></div>

            <div class="twoCol">
              <div>
                <label class="footnote">Client declares information is accurate</label>
                <select id="waiverAccurate">
                  <option value="">Select…</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div>
                <label class="footnote">Client agrees to proceed with coaching assessment</label>
                <select id="waiverProceed">
                  <option value="">Select…</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="twoCol">
              <div>
                <label class="footnote">Client Signature (type name)</label>
                <input type="text" id="clientSignature" placeholder="e.g., Alex Tan" />
              </div>
              <div>
                <label class="footnote">Signature Date</label>
                <input type="date" id="signatureDate" />
              </div>
            </div>

          </div>
        </details>

        <div class="hr"></div>

        <div class="sectionTitle">Movement (Able / Unable + Limitations if Unable)</div>
        <div class="scrollHint">Tip: swipe left/right to view all columns →</div>
        <div class="tableWrap"><div id="movementTable"></div></div>

        <div class="hr"></div>

        <div class="sectionTitle">Strength & Stability (Able/Unable per side)</div>
        <div class="scrollHint">Tip: swipe left/right to view all columns →</div>
        <div class="tableWrap"><div id="strengthTable"></div></div>

        <div class="hr"></div>

        <div class="sectionTitle">Foot Assessment (Able/Unable per side)</div>
        <div class="scrollHint">Tip: swipe left/right to view all columns →</div>
        <div class="tableWrap"><div id="footTable"></div></div>

        <div class="hr"></div>

        <div class="sectionTitle">Ankle ROM (Inability) — L / R</div>
        <div id="ankleRomBlock"></div>

        <div class="hr"></div>

        <div class="sectionTitle">Gait analysis findings</div>
        <div class="footnote">Tap to select. Add extra notes if needed.</div>
        <div id="gaitFindingsChips" class="chips" style="margin-top:8px;"></div>
        <div style="height:10px"></div>
        <textarea id="gaitFindingsNotes" placeholder="Details: when it occurs, severity, cues tried, treadmill speed, cadence notes, video timestamp, etc."></textarea>

        <div class="hr"></div>

        <div class="sectionTitle">Coach notes</div>
        <textarea id="notes" placeholder="Key observations, cues, priorities, plan..."></textarea>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <div class="hd">
        <h2>Summary & Flags</h2>
        <span class="pill" id="lastSaved">Not saved yet</span>
      </div>
      <div class="bd">
        <div class="kpi">
          <div class="stat">
            <b id="kpiUnable">0</b>
            <span>Unable selected</span>
          </div>
          <div class="stat">
            <b id="kpiLimit">0</b>
            <span>Limitations selected</span>
          </div>
          <div class="stat">
            <b id="kpiLR">0</b>
            <span>L/R selections</span>
          </div>
        </div>

        <div class="sectionTitle">Quick flags</div>
        <div id="flagTags"></div>

        <div class="sectionTitle">Recommended Mobility / Stability Exercises</div>
        <div class="summaryBox" id="recBox">Fill in the assessment to generate recommendations.</div>

        <div class="sectionTitle">Auto-generated summary</div>
        <div class="summaryBox" id="summaryBox">Fill in the assessment to generate a summary.</div>

        <div class="sectionTitle">Data management</div>
        <div class="inline">
          <label class="tag" title="Toggle automatic saving to this browser">
            <input type="checkbox" id="autosave" />
            Autosave to device
          </label>
          <label class="tag" title="Optional case ID for exports">
            <span style="color:var(--muted)">Case ID</span>
            <input type="text" id="caseId" placeholder="e.g., AT-2026-01-06"
              style="width:180px;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background: rgba(10,16,30,.65);color:var(--text);" />
          </label>
        </div>
        <div class="footnote">Save/Load uses browser localStorage (works on GitHub Pages).</div>
      </div>
    </aside>
  </div>
</main>

<footer>
  <div class="copyRow">
    <div>© <span id="yr"></span> <b>Dr. Ng Jun Wei, EdD, MSc, BSc, CSCS, CRGA</b></div>
    <div>Runner Readiness Assessment • For coaching/education use</div>
  </div>
</footer>

<script>
  // =========================================================
  // BRAND / COPYRIGHT
  // =========================================================
  const COPYRIGHT = "© " + new Date().getFullYear() + " Dr. Ng Jun Wei, EdD, MSc, BSc, CSCS, CRGA";

  // =========================================================
  // CONFIG
  // =========================================================
  const MOVEMENT = [
    { key: "toe_touch", label: "Toe Touch", limits: ["Hamstring Tightness","Back Tightness","Core/Back Control","General Limitation"] },
    { key: "back_bend", label: "Back Bend", limits: ["Hip Ext Tightness","Back Tightness","Core/Back Control","General Limitation"] },
    { key: "rotation", label: "Rotation", limits: ["Hip Tightness","Thoracic Tightness","Hip Rotation Control","Thoracic Rotation Control","General Limitation"] },
    { key: "single_leg_balance", label: "Single Leg Balance", limits: ["Foot/Ankle Control","Hip Control"] },
    { key: "squat", label: "Squat", limits: ["Ankle Tightness","Hip Tightness","Form/General Limitation"] }
  ];

  const STRENGTH = [
    { key: "bridge", label: "Bridge" },
    { key: "side_plank", label: "Side Plank" },
    { key: "sl_sit_to_stand", label: "Single Leg Sit-to-Stand" },
    { key: "calf_raise", label: "Calf Raise" }
  ];

  const FOOT = [
    { key: "toe_splay", label: "Toe Splay" },
    { key: "great_toe_extension", label: "Great Toe Extension" },
    { key: "great_toe_abduction", label: "Great Toe Abduction" }
  ];

  const ANKLE_ROM = [
    { key: "eversion", label: "Eversion inability", glyph: "↗︎" },
    { key: "inversion", label: "Inversion inability", glyph: "↖︎" },
    { key: "supination", label: "Supination inability", glyph: "⤴︎" },
    { key: "pronation", label: "Pronation inability", glyph: "⤵︎" }
  ];

  const GAIT_FINDINGS = [
    "Overstrider",
    "Bouncer",
    "Weaver",
    "Crossover",
    "Collapser",
    "Heavy lander",
    "Low cadence",
    "Excess vertical oscillation",
    "Hip drop / Trendelenburg",
    "Lateral pelvic tilt",
    "Excess trunk lean",
    "Excess arm swing / rotation"
  ];

  const STORAGE_KEY = "runner_readiness_assessment_v8";

  // =========================================================
  // RECOMMENDATION LIBRARY
  // =========================================================
  const RECS = {
    movement: {
      toe_touch: {
        mobility: ["Hamstring floss (banded) 2×10/side", "Supine hamstring stretch 2×30–45s/side", "Hip hinge patterning with dowel 2×8"],
        stability: ["Dead bug (controlled) 2×6–8/side", "Bird-dog (slow) 2×6/side"]
      },
      back_bend: {
        mobility: ["Half-kneeling hip flexor stretch 2×30–45s/side", "Thoracic extension over foam roller 2×6–8", "Prone press-up (as tolerated) 2×8"],
        stability: ["Glute bridge hold 3×20–30s", "Side plank (knees) 2×20–30s/side"]
      },
      rotation: {
        mobility: ["Open books (thoracic rotation) 2×8/side", "90/90 hip switches 2×6/side", "Hip IR/ER stretch 2×30s/side"],
        stability: ["Pallof press 2×8–10/side", "Split-stance anti-rotation hold 2×20s/side"]
      },
      single_leg_balance: {
        mobility: ["Ankle dorsiflexion rocks 2×10/side", "Toe yoga (lift big toe/others) 2×8"],
        stability: ["Single-leg balance (eyes open) 3×20–30s", "Short-foot exercise 2×8–10", "Single-leg RDL reach (light) 2×6/side"]
      },
      squat: {
        mobility: ["Knee-to-wall ankle DF drill 2×10/side", "Couch stretch (hip flexor) 2×30s/side", "Adductor rock-backs 2×8/side"],
        stability: ["Goblet squat to box (control) 2×6–8", "Mini-band lateral steps 2×10/side", "Tempo squat (3s down) 2×5"]
      }
    },
    strength: {
      bridge: { stability: ["Glute bridge iso hold 3×20–30s", "Marching bridge 2×6/side"], mobility: ["Hip flexor stretch 2×30s/side"] },
      side_plank: { stability: ["Side plank (knees) 3×15–25s/side", "Side-lying hip abduction 2×10/side"], mobility: ["QL/lat gentle stretch 2×20s/side"] },
      sl_sit_to_stand: { stability: ["Single-leg sit-to-stand to higher box 2×5/side", "Step-down (slow) 2×6/side", "Split squat (supported) 2×6/side"], mobility: ["Ankle DF drill 2×10/side"] },
      calf_raise: { stability: ["Single-leg calf raise (support) 3×6–10/side", "Eccentric heel drop 2×8/side"], mobility: ["Calf stretch (gastroc/soleus) 2×30s/side"] }
    },
    foot: {
      toe_splay: { mobility: ["Toe splay practice 2×8", "Toe spacers (if tolerated) 5–10 min"], stability: ["Short-foot exercise 2×8–10", "Single-leg balance with tripod foot 2×20s/side"] },
      great_toe_extension: { mobility: ["Great toe extension stretch 2×30s/side", "Plantar fascia roll 1–2 min/foot"], stability: ["Towel scrunches 2×10", "Calf raises focusing on big toe pressure 2×8–10"] },
      great_toe_abduction: { mobility: ["Toe yoga (big toe up/down) 2×8", "Manual big-toe abduction stretch 2×20s"], stability: ["Short-foot + big toe press 2×8", "Band-resisted toe abduction 2×8–10"] }
    },
    ankleRom: {
      eversion: { mobility:["Banded ankle eversion 2×10/side", "Peroneal soft tissue release 1–2 min"], stability:["Single-leg balance (tripod) 2×20s/side"] },
      inversion: { mobility:["Banded ankle inversion 2×10/side", "Posterior tib activation (band) 2×10"], stability:["Arch control holds 2×20s/side"] },
      supination:{ mobility:["Foot mobility circles 2×6 each direction", "Midfoot mobilization (gentle) 1–2 min"], stability:["Short-foot exercise 2×8–10"] },
      pronation:{ mobility:["Calf/soleus stretch 2×30s/side", "Ankle DF knee-to-wall 2×10"], stability:["Tibialis posterior raises 2×10", "Single-leg balance 2×20s/side"] }
    },
    gait: {
      Overstrider: { mobility:["Hip flexor stretch 2×30s/side","Ankle DF drill 2×10/side"], stability:["Cadence build (metronome) +5–8%","Single-leg RDL reach 2×6/side"] },
      Bouncer: { mobility:["Calf/soleus stretch 2×30s/side"], stability:["Marching drills (A-march) 2×20m","Core anti-extension (dead bug) 2×6/side"] },
      Weaver: { mobility:["Adductor rock-backs 2×8/side","Hip IR/ER stretch 2×30s/side"], stability:["Mini-band lateral steps 2×10/side","Single-leg balance 2×20s/side"] },
      Crossover: { mobility:["TFL/hip stretch 2×20s/side"], stability:["Glute med work (side-lying abduction) 2×10/side","Step-down control 2×6/side"] },
      Collapser: { mobility:["Hip ER stretch 2×30s/side"], stability:["Split squat (supported) 2×6/side","Short-foot 2×8–10"] },
      "Heavy lander": { mobility:["Ankle DF drill 2×10/side"], stability:["Soft landing drills (low pogo) 2×10","Tempo squat 2×5"] },
      "Low cadence": { mobility:["Hip mobility flow 2×45s"], stability:["Metronome cadence +5–8%","Wall march drill 2×20s"] }
    }
  };

  // =========================================================
  // STATE
  // =========================================================
  const STATE = { toggles: {}, movementLimits: {}, gaitFindings: [] };

  // =========================================================
  // DOM helpers
  // =========================================================
  function el(tag, attrs={}, children=[]){
    const n = document.createElement(tag);
    for(const [k,v] of Object.entries(attrs)){
      if(k === "class") n.className = v;
      else if(k === "html") n.innerHTML = v;
      else n.setAttribute(k, v);
    }
    children.forEach(c => n.appendChild(c));
    return n;
  }
  function esc(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  function getVal(id){ return (document.getElementById(id)?.value ?? "").trim(); }
  function setVal(id, v){ const x=document.getElementById(id); if(x) x.value=v; }
  function cssEsc(str){ return String(str).replace(/"/g, '\\"'); }

  // =========================================================
  // Toggle primitives
  // =========================================================
  function getToggle(id){ return !!STATE.toggles[id]; }
  function setToggle(id, v){
    STATE.toggles[id] = !!v;
    const btn = document.querySelector(`[data-tid="${cssEsc(id)}"]`);
    if(btn) btn.classList.toggle("on", !!v);
  }

  function makeToggleButton(id, label, {variant="good", onToggle=null} = {}){
    const btn = el("div", {
      class: `toggleBtn ${variant === "bad" ? "bad" : ""}`,
      "data-tid": id,
      role:"button",
      tabindex:"0",
      "aria-pressed": "false"
    }, [
      el("div", { class:"tick" }),
      el("div", { html: esc(label) })
    ]);

    function toggle(){
      const next = !getToggle(id);
      setToggle(id, next);
      btn.setAttribute("aria-pressed", next ? "true" : "false");
      if(typeof onToggle === "function") onToggle(next);
      onAnyChange();
    }

    btn.addEventListener("click", toggle);
    btn.addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        toggle();
      }
    });

    setToggle(id, false);
    return btn;
  }

  // =========================================================
  // Movement table
  // =========================================================
  function buildMovementTable(){
    const table = el("table", { class:"tbl" });
    const thead = el("thead");
    const trh = el("tr");
    trh.appendChild(el("th", { class:"metricCell", html:"Metric (tap to clear row)" }));
    trh.appendChild(el("th", { html:"Able" }));
    trh.appendChild(el("th", { html:"Unable" }));
    trh.appendChild(el("th", { html:"If Unable: Click limitations (multi-select)" }));
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = el("tbody");

    MOVEMENT.forEach(m => {
      const ableId = `mv__${m.key}__able`;
      const unableId = `mv__${m.key}__unable`;
      if(!STATE.movementLimits[m.key]) STATE.movementLimits[m.key] = [];

      const tr = el("tr");

      const metricTd = el("td", { class:"metricCell", html: esc(m.label) });
      metricTd.addEventListener("click", () => {
        const any = getToggle(ableId) || getToggle(unableId) || (STATE.movementLimits[m.key] || []).length;
        if(!any) return;
        if(!confirm(`Clear "${m.label}" (Able/Unable + limitations)?`)) return;
        setToggle(ableId, false);
        setToggle(unableId, false);
        STATE.movementLimits[m.key] = [];
        refreshLimitChips(m.key);
        setLimitCellEnabled(m.key, false);
        onAnyChange();
      });
      tr.appendChild(metricTd);

      const ableTd = el("td");
      ableTd.appendChild(makeToggleButton(ableId, "Able", {
        variant: "good",
        onToggle: (on) => {
          if(on){
            setToggle(unableId, false);
            STATE.movementLimits[m.key] = [];
            refreshLimitChips(m.key);
            setLimitCellEnabled(m.key, false);
          }
        }
      }));
      tr.appendChild(ableTd);

      const unableTd = el("td");
      unableTd.appendChild(makeToggleButton(unableId, "Unable", {
        variant: "bad",
        onToggle: (on) => {
          if(on){
            setToggle(ableId, false);
            setLimitCellEnabled(m.key, true);
          }else{
            STATE.movementLimits[m.key] = [];
            refreshLimitChips(m.key);
            setLimitCellEnabled(m.key, false);
          }
        }
      }));
      tr.appendChild(unableTd);

      const limitTd = el("td", { id: `mv__${m.key}__limitsCell` });
      const hint = el("div", { class:"limitsHint", id:`mv__${m.key}__hint`, html:"Select <b>Unable</b> to enable limitations." });
      const chipWrap = el("div", { class:"chips", id: `mv__${m.key}__chips` });

      m.limits.forEach(lab => {
        const chip = el("span", { class:"chip", "data-mkey": m.key, "data-lab": lab }, [
          el("span", { class:"dot" }),
          document.createTextNode(lab)
        ]);
        chip.addEventListener("click", () => {
          if(!getToggle(unableId)) return;
          const selected = new Set(STATE.movementLimits[m.key] || []);
          if(selected.has(lab)) selected.delete(lab);
          else selected.add(lab);
          STATE.movementLimits[m.key] = Array.from(selected);
          refreshLimitChips(m.key);
          onAnyChange();
        });
        chipWrap.appendChild(chip);
      });

      limitTd.appendChild(hint);
      limitTd.appendChild(chipWrap);
      tr.appendChild(limitTd);

      tbody.appendChild(tr);

      setLimitCellEnabled(m.key, false);
      refreshLimitChips(m.key);
    });

    table.appendChild(tbody);
    document.getElementById("movementTable").innerHTML = "";
    document.getElementById("movementTable").appendChild(table);
  }

  function refreshLimitChips(metricKey){
    const wrap = document.getElementById(`mv__${metricKey}__chips`);
    if(!wrap) return;
    const selected = new Set(STATE.movementLimits[metricKey] || []);
    [...wrap.querySelectorAll(".chip")].forEach(chip => {
      const lab = chip.getAttribute("data-lab");
      chip.classList.toggle("on", selected.has(lab));
    });
  }

  function setLimitCellEnabled(metricKey, enabled){
    const hint = document.getElementById(`mv__${metricKey}__hint`);
    const chips = document.getElementById(`mv__${metricKey}__chips`);
    if(!chips || !hint) return;
    chips.style.opacity = enabled ? "1" : ".45";
    chips.style.pointerEvents = enabled ? "auto" : "none";
    hint.style.display = enabled ? "none" : "block";
  }

  // =========================================================
  // Strength / Foot tables
  // =========================================================
  function buildLRTable(containerId, prefix, items){
    const table = el("table", { class:"tbl" });

    const thead = el("thead");
    const trh = el("tr");
    trh.appendChild(el("th", { class:"metricCell", html:"Metric (tap to clear row)" }));
    trh.appendChild(el("th", { html:"Able (L)" }));
    trh.appendChild(el("th", { html:"Able (R)" }));
    trh.appendChild(el("th", { html:"Unable (L)" }));
    trh.appendChild(el("th", { html:"Unable (R)" }));
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = el("tbody");

    items.forEach(it => {
      const tr = el("tr");
      const aL = `${prefix}__${it.key}__able__L`;
      const aR = `${prefix}__${it.key}__able__R`;
      const uL = `${prefix}__${it.key}__unable__L`;
      const uR = `${prefix}__${it.key}__unable__R`;

      const metricTd = el("td", { class:"metricCell", html: esc(it.label) });
      metricTd.addEventListener("click", () => {
        const ids = [aL,aR,uL,uR];
        const any = ids.some(id => getToggle(id));
        if(!any) return;
        if(!confirm(`Clear "${it.label}" (L/R Able/Unable)?`)) return;
        ids.forEach(id => setToggle(id,false));
        onAnyChange();
      });
      tr.appendChild(metricTd);

      const td1 = el("td");
      td1.appendChild(makeToggleButton(aL, "Able", { variant:"good", onToggle:(on)=>{ if(on) setToggle(uL,false); } }));
      tr.appendChild(td1);

      const td2 = el("td");
      td2.appendChild(makeToggleButton(aR, "Able", { variant:"good", onToggle:(on)=>{ if(on) setToggle(uR,false); } }));
      tr.appendChild(td2);

      const td3 = el("td");
      td3.appendChild(makeToggleButton(uL, "Unable", { variant:"bad", onToggle:(on)=>{ if(on) setToggle(aL,false); } }));
      tr.appendChild(td3);

      const td4 = el("td");
      td4.appendChild(makeToggleButton(uR, "Unable", { variant:"bad", onToggle:(on)=>{ if(on) setToggle(aR,false); } }));
      tr.appendChild(td4);

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    document.getElementById(containerId).innerHTML = "";
    document.getElementById(containerId).appendChild(table);
  }

  // =========================================================
  // Ankle ROM
  // =========================================================
  function buildAnkleBlock(){
    const grid = el("div", { class:"ankleGrid" });
    grid.appendChild(el("div", { class:"ankleCell ankleHead", html:"Ankle motion (inability)" }));
    grid.appendChild(el("div", { class:"ankleCell ankleHead", html:"Left" }));
    grid.appendChild(el("div", { class:"ankleCell ankleHead", html:"Right" }));

    ANKLE_ROM.forEach(r => {
      const idL = `ank__${r.key}__L`;
      const idR = `ank__${r.key}__R`;

      const labelCell = el("div", { class:"ankleCell ankleLabel" }, [
        el("div", { class:"glyph", html: esc(r.glyph) }),
        el("div", { html: esc(r.label) })
      ]);
      labelCell.addEventListener("click", () => {
        const any = getToggle(idL) || getToggle(idR);
        if(!any) return;
        if(!confirm(`Clear "${r.label}" (L/R)?`)) return;
        setToggle(idL,false); setToggle(idR,false);
        onAnyChange();
      });

      const leftCell = el("div", { class:"ankleCell" });
      leftCell.appendChild(makeToggleButton(idL, "Limited", { variant:"bad" }));

      const rightCell = el("div", { class:"ankleCell" });
      rightCell.appendChild(makeToggleButton(idR, "Limited", { variant:"bad" }));

      grid.appendChild(labelCell);
      grid.appendChild(leftCell);
      grid.appendChild(rightCell);
    });

    document.getElementById("ankleRomBlock").innerHTML = "";
    document.getElementById("ankleRomBlock").appendChild(grid);
  }

  // =========================================================
  // Gait Findings chips
  // =========================================================
  function buildGaitFindings(){
    const wrap = document.getElementById("gaitFindingsChips");
    if(!wrap) return;
    wrap.innerHTML = "";

    GAIT_FINDINGS.forEach(label => {
      const chip = el("span", { class:"chip", "data-gait": label }, [
        el("span", { class:"dot" }),
        document.createTextNode(label)
      ]);

      chip.addEventListener("click", () => {
        const s = new Set(STATE.gaitFindings || []);
        if(s.has(label)) s.delete(label);
        else s.add(label);
        STATE.gaitFindings = Array.from(s);
        refreshGaitChips();
        onAnyChange();
      });

      wrap.appendChild(chip);
    });

    refreshGaitChips();
  }

  function refreshGaitChips(){
    const wrap = document.getElementById("gaitFindingsChips");
    if(!wrap) return;
    const selected = new Set(STATE.gaitFindings || []);
    [...wrap.querySelectorAll(".chip")].forEach(chip => {
      const lab = chip.getAttribute("data-gait");
      chip.classList.toggle("on", selected.has(lab));
    });
  }

  // =========================================================
  // Waiver collect + apply
  // =========================================================
  function collectWaiver(){
    return {
      yearsRunning: getVal("yearsRunning"),
      runsPerWeek: getVal("runsPerWeek"),
      mileagePerWeek: getVal("mileagePerWeek"),
      runningGoals: getVal("runningGoals"),
      mskHistory: getVal("mskHistory"),
      stressFracture: getVal("stressFracture"),
      medicalClearance: getVal("medicalClearance"),
      waiverAccurate: getVal("waiverAccurate"),
      waiverProceed: getVal("waiverProceed"),
      clientSignature: getVal("clientSignature"),
      signatureDate: getVal("signatureDate"),
      waiverOpen: document.getElementById("waiverDetails")?.open ? "Yes" : "No"
    };
  }

  function applyWaiver(w){
    if(!w) return;
    setVal("yearsRunning", w.yearsRunning || "");
    setVal("runsPerWeek", w.runsPerWeek || "");
    setVal("mileagePerWeek", w.mileagePerWeek || "");
    setVal("runningGoals", w.runningGoals || "");
    setVal("mskHistory", w.mskHistory || "");
    setVal("stressFracture", w.stressFracture || "");
    setVal("medicalClearance", w.medicalClearance || "");
    setVal("waiverAccurate", w.waiverAccurate || "");
    setVal("waiverProceed", w.waiverProceed || "");
    setVal("clientSignature", w.clientSignature || "");
    setVal("signatureDate", w.signatureDate || "");
    const det = document.getElementById("waiverDetails");
    if(det) det.open = (w.waiverOpen === "Yes");
  }

  // =========================================================
  // Recommendations generator
  // =========================================================
  function uniq(arr){
    const out = [];
    const seen = new Set();
    for(const x of arr){
      const k = String(x).trim();
      if(!k) continue;
      if(seen.has(k)) continue;
      seen.add(k);
      out.push(k);
    }
    return out;
  }

  function collectRecommendations(){
    const mobility = [];
    const stability = [];
    const notes = [];

    MOVEMENT.forEach(m => {
      const unable = getToggle(`mv__${m.key}__unable`);
      if(!unable) return;
      const lib = RECS.movement[m.key];
      if(lib?.mobility) mobility.push(...lib.mobility);
      if(lib?.stability) stability.push(...lib.stability);

      const limits = STATE.movementLimits[m.key] || [];
      if(limits.length){
        notes.push(`${m.label} limitations: ${limits.join(", ")}`);
        if(limits.some(x => /control|form/i.test(x))){
          stability.push("Add 1–2 anti-rotation / core control drills (Pallof, dead bug) 2–3×/week");
        }
      }
    });

    STRENGTH.forEach(it => {
      const uL = getToggle(`st__${it.key}__unable__L`);
      const uR = getToggle(`st__${it.key}__unable__R`);
      if(!(uL||uR)) return;
      const lib = RECS.strength[it.key];
      if(lib?.stability) stability.push(...lib.stability);
      if(lib?.mobility) mobility.push(...lib.mobility);
      notes.push(`${it.label} unable: ${(uL&&uR)?"L+R":(uL?"L":"R")}`);
    });

    FOOT.forEach(it => {
      const uL = getToggle(`ft__${it.key}__unable__L`);
      const uR = getToggle(`ft__${it.key}__unable__R`);
      if(!(uL||uR)) return;
      const lib = RECS.foot[it.key];
      if(lib?.mobility) mobility.push(...lib.mobility);
      if(lib?.stability) stability.push(...lib.stability);
      notes.push(`${it.label} unable: ${(uL&&uR)?"L+R":(uL?"L":"R")}`);
    });

    ANKLE_ROM.forEach(r => {
      const L = getToggle(`ank__${r.key}__L`);
      const R = getToggle(`ank__${r.key}__R`);
      if(!(L||R)) return;
      const lib = RECS.ankleRom[r.key];
      if(lib?.mobility) mobility.push(...lib.mobility);
      if(lib?.stability) stability.push(...lib.stability);
      notes.push(`${r.label}: ${(L&&R)?"L+R":(L?"L":"R")}`);
    });

    (STATE.gaitFindings || []).forEach(g => {
      const lib = RECS.gait?.[g];
      if(!lib) return;
      if(lib.mobility) mobility.push(...lib.mobility);
      if(lib.stability) stability.push(...lib.stability);
      notes.push(`Gait finding: ${g}`);
    });

    return {
      mobility: uniq(mobility),
      stability: uniq(stability),
      notes: uniq(notes)
    };
  }

  function formatRecsText(recs){
    const lines = [];
    if(!recs.mobility.length && !recs.stability.length){
      return "No recommendations yet.\nTip: mark any area as Unable/Limited or tag gait findings to generate suggestions.";
    }
    lines.push("Mobility focus");
    lines.push(...(recs.mobility.length ? recs.mobility.map(x => `- ${x}`) : ["- (none)"]));
    lines.push("");
    lines.push("Stability / Control focus");
    lines.push(...(recs.stability.length ? recs.stability.map(x => `- ${x}`) : ["- (none)"]));
    if(recs.notes.length){
      lines.push("");
      lines.push("Triggers");
      lines.push(...recs.notes.map(x => `- ${x}`));
    }
    lines.push("");
    lines.push("Programming hint");
    lines.push("- Choose 2–4 drills total, 2–4×/week. Keep pain-free, progress gradually.");
    return lines.join("\n");
  }

  // =========================================================
  // Collect / Apply for save/load/export
  // =========================================================
  function collectAll(){
    return {
      meta: {
        clientName: getVal("clientName"),
        assessDate: getVal("assessDate"),
        caseId: getVal("caseId"),
        savedAtISO: new Date().toISOString()
      },
      waiver: collectWaiver(),
      notes: getVal("notes"),
      gaitFindings: STATE.gaitFindings || [],
      gaitFindingsNotes: getVal("gaitFindingsNotes"),
      toggles: STATE.toggles,
      movementLimits: STATE.movementLimits
    };
  }

  function applyAll(data){
    if(!data) return;

    setVal("clientName", data?.meta?.clientName || "");
    setVal("assessDate", data?.meta?.assessDate || "");
    setVal("caseId", data?.meta?.caseId || "");
    setVal("notes", data?.notes || "");
    setVal("gaitFindingsNotes", data?.gaitFindingsNotes || "");
    applyWaiver(data?.waiver || {});

    STATE.toggles = {};
    STATE.movementLimits = {};
    STATE.gaitFindings = Array.isArray(data?.gaitFindings) ? data.gaitFindings : [];

    // restore toggles
    const t = data?.toggles || {};
    for(const [id,v] of Object.entries(t)){
      STATE.toggles[id] = !!v;
      const btn = document.querySelector(`[data-tid="${cssEsc(id)}"]`);
      if(btn) btn.classList.toggle("on", !!v);
    }

    // restore movement limitations + enable chips if unable
    const ml = data?.movementLimits || {};
    MOVEMENT.forEach(m => {
      STATE.movementLimits[m.key] = Array.isArray(ml[m.key]) ? ml[m.key] : [];
      refreshLimitChips(m.key);
      setLimitCellEnabled(m.key, !!STATE.toggles[`mv__${m.key}__unable`]);
    });

    refreshGaitChips();
    updateSavedPill(data?.meta?.savedAtISO || null);
    onAnyChange();
  }

  // =========================================================
  // Save / Load / Reset
  // =========================================================
  function updateSavedPill(iso){
    const pill = document.getElementById("lastSaved");
    if(!iso){ pill.textContent = "Not saved yet"; return; }
    pill.textContent = `Saved: ${new Date(iso).toLocaleString()}`;
  }

  function save(){
    const data = collectAll();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    updateSavedPill(data.meta.savedAtISO);
  }

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ alert("No saved assessment found on this device yet."); return; }
    try{ applyAll(JSON.parse(raw)); }
    catch(e){ alert("Saved data was corrupted or unreadable."); }
  }

  function resetAll(){
    if(!confirm("Reset the form? This will clear everything on-screen.")) return;

    setVal("clientName","");
    setVal("caseId","");
    setVal("notes","");
    setVal("gaitFindingsNotes","");
    document.getElementById("assessDate").value = new Date().toISOString().slice(0,10);

    [
      "yearsRunning","runsPerWeek","mileagePerWeek","runningGoals","mskHistory",
      "stressFracture","medicalClearance","waiverAccurate","waiverProceed",
      "clientSignature","signatureDate"
    ].forEach(id => setVal(id,""));
    document.getElementById("waiverDetails").open = false;

    for(const id of Object.keys(STATE.toggles)){
      STATE.toggles[id] = false;
      const btn = document.querySelector(`[data-tid="${cssEsc(id)}"]`);
      if(btn) btn.classList.remove("on");
    }

    MOVEMENT.forEach(m => {
      STATE.movementLimits[m.key] = [];
      refreshLimitChips(m.key);
      setLimitCellEnabled(m.key, false);
    });

    STATE.gaitFindings = [];
    refreshGaitChips();

    updateSavedPill(null);
    onAnyChange();
  }

  // =========================================================
  // Summary + Flags + Recs
  // =========================================================
  function sideText(L,R){
    if(L && R) return "L+R";
    if(L) return "L";
    if(R) return "R";
    return "—";
  }

  function renderTags(tags){
    const box = document.getElementById("flagTags");
    box.innerHTML = "";
    if(!tags.length){
      box.innerHTML = `<span class="footnote">No flags yet.</span>`;
      return;
    }
    tags.slice(0, 18).forEach(t => {
      const span = document.createElement("span");
      span.className = "tag";
      const dot = document.createElement("span");
      dot.className = `dotTag ${t.level}`;
      span.appendChild(dot);
      span.appendChild(document.createTextNode(t.text));
      box.appendChild(span);
    });
  }

  function waiverSummaryLines(){
    const lines = [];
    const yrs = getVal("yearsRunning");
    const rpw = getVal("runsPerWeek");
    const mpw = getVal("mileagePerWeek");
    const goals = getVal("runningGoals");
    const msk = getVal("mskHistory");
    const sf = getVal("stressFracture");
    const mc = getVal("medicalClearance");
    const acc = getVal("waiverAccurate");
    const proc = getVal("waiverProceed");
    const sig = getVal("clientSignature");
    const sigd = getVal("signatureDate");

    if(yrs || rpw || mpw){
      lines.push("Training History");
      lines.push(`- Years running: ${yrs || "—"}`);
      lines.push(`- Runs/week: ${rpw || "—"}`);
      lines.push(`- Mileage/week (km): ${mpw || "—"}`);
      lines.push("");
    }
    if(goals){
      lines.push("Goals");
      lines.push(`- ${goals}`);
      lines.push("");
    }
    if(msk || sf || mc){
      lines.push("Injury / Medical");
      if(msk) lines.push(`- MSK history: ${msk}`);
      if(sf) lines.push(`- Stress fracture: ${sf}`);
      if(mc) lines.push(`- Medical clearance: ${mc}`);
      lines.push("");
    }
    if(acc || proc || sig || sigd){
      lines.push("Waiver");
      if(acc) lines.push(`- Accuracy confirmed: ${acc}`);
      if(proc) lines.push(`- Proceed with assessment: ${proc}`);
      if(sig) lines.push(`- Signature: ${sig}`);
      if(sigd) lines.push(`- Signature date: ${sigd}`);
      lines.push("");
    }
    return lines;
  }

  function buildSummaryText(){
    const name = getVal("clientName") || "Client";
    const date = getVal("assessDate") || "Date not set";
    const lines = [];
    lines.push(`${name} • ${date}`);
    lines.push("");

    const wLines = waiverSummaryLines();
    if(wLines.length) lines.push(...wLines);

    const gf = (STATE.gaitFindings || []);
    const gfNotes = getVal("gaitFindingsNotes");
    if(gf.length || gfNotes){
      lines.push("Gait Analysis Findings");
      if(gf.length) lines.push(`- Tags: ${gf.join(", ")}`);
      if(gfNotes) lines.push(`- Notes: ${gfNotes}`);
      lines.push("");
    }

    lines.push("Movement");
    MOVEMENT.forEach(m => {
      const able = getToggle(`mv__${m.key}__able`);
      const unable = getToggle(`mv__${m.key}__unable`);
      const limits = STATE.movementLimits[m.key] || [];
      if(able || unable || limits.length){
        const status = able ? "Able" : (unable ? "Unable" : "—");
        const lim = (unable && limits.length) ? ` | Limitations: ${limits.join(", ")}` : "";
        lines.push(`- ${m.label}: ${status}${lim}`);
      }
    });

    lines.push("");
    lines.push("Strength & Stability (L/R)");
    STRENGTH.forEach(it => {
      const aL = getToggle(`st__${it.key}__able__L`);
      const aR = getToggle(`st__${it.key}__able__R`);
      const uL = getToggle(`st__${it.key}__unable__L`);
      const uR = getToggle(`st__${it.key}__unable__R`);
      if(aL||aR||uL||uR){
        lines.push(`- ${it.label}: Able(${sideText(aL,aR)}) | Unable(${sideText(uL,uR)})`);
      }
    });

    lines.push("");
    lines.push("Foot Assessment (L/R)");
    FOOT.forEach(it => {
      const aL = getToggle(`ft__${it.key}__able__L`);
      const aR = getToggle(`ft__${it.key}__able__R`);
      const uL = getToggle(`ft__${it.key}__unable__L`);
      const uR = getToggle(`ft__${it.key}__unable__R`);
      if(aL||aR||uL||uR){
        lines.push(`- ${it.label}: Able(${sideText(aL,aR)}) | Unable(${sideText(uL,uR)})`);
      }
    });

    lines.push("");
    lines.push("Ankle ROM (Inability) (L/R)");
    ANKLE_ROM.forEach(r => {
      const L = getToggle(`ank__${r.key}__L`);
      const R = getToggle(`ank__${r.key}__R`);
      if(L||R){
        lines.push(`- ${r.label}: ${sideText(L,R)}`);
      }
    });

    const notes = getVal("notes");
    if(notes){
      lines.push("");
      lines.push("Coach Notes");
      lines.push(notes);
    }

    lines.push("");
    lines.push(COPYRIGHT);
    return lines.join("\n");
  }

  function onAnyChange(){
    let unableCount = 0;
    MOVEMENT.forEach(m => { if(getToggle(`mv__${m.key}__unable`)) unableCount++; });

    let limitCount = 0;
    MOVEMENT.forEach(m => { limitCount += (STATE.movementLimits[m.key] || []).length; });

    let lrCount = 0;
    const lrKeys = [
      ...STRENGTH.flatMap(it => [
        `st__${it.key}__able__L`,`st__${it.key}__able__R`,`st__${it.key}__unable__L`,`st__${it.key}__unable__R`
      ]),
      ...FOOT.flatMap(it => [
        `ft__${it.key}__able__L`,`ft__${it.key}__able__R`,`ft__${it.key}__unable__L`,`ft__${it.key}__unable__R`
      ]),
      ...ANKLE_ROM.flatMap(r => [`ank__${r.key}__L`,`ank__${r.key}__R`])
    ];
    lrKeys.forEach(id => { if(getToggle(id)) lrCount++; });

    document.getElementById("kpiUnable").textContent = unableCount;
    document.getElementById("kpiLimit").textContent = limitCount;
    document.getElementById("kpiLR").textContent = lrCount;

    const tags = [];
    const sf = getVal("stressFracture");
    const mc = getVal("medicalClearance");
    const proc = getVal("waiverProceed");
    if(sf && sf.includes("current")) tags.push({ text:`Waiver: Current stress fracture indicated`, level:"bad" });
    if(mc && mc.includes("Required")) tags.push({ text:`Waiver: Medical clearance required (pending)`, level:"warn" });
    if(proc === "No") tags.push({ text:`Waiver: Client did NOT agree to proceed`, level:"bad" });

    const gf = (STATE.gaitFindings || []);
    if(gf.length) tags.push({ text:`Gait tags: ${gf.join(", ")}`, level:"warn" });

    MOVEMENT.forEach(m => {
      const unable = getToggle(`mv__${m.key}__unable`);
      const limits = STATE.movementLimits[m.key] || [];
      if(unable) tags.push({ text:`Movement: ${m.label} = Unable`, level:"bad" });
      if(unable && limits.length) tags.push({ text:`${m.label} limitations: ${limits.join(", ")}`, level:"warn" });
    });

    STRENGTH.forEach(it => {
      const uL = getToggle(`st__${it.key}__unable__L`);
      const uR = getToggle(`st__${it.key}__unable__R`);
      if(uL||uR) tags.push({ text:`Strength: ${it.label} unable (${sideText(uL,uR)})`, level:"bad" });
    });

    FOOT.forEach(it => {
      const uL = getToggle(`ft__${it.key}__unable__L`);
      const uR = getToggle(`ft__${it.key}__unable__R`);
      if(uL||uR) tags.push({ text:`Foot: ${it.label} unable (${sideText(uL,uR)})`, level:"bad" });
    });

    ANKLE_ROM.forEach(r => {
      const L = getToggle(`ank__${r.key}__L`);
      const R = getToggle(`ank__${r.key}__R`);
      if(L||R) tags.push({ text:`Ankle ROM: ${r.label} (${sideText(L,R)})`, level:"bad" });
    });

    renderTags(tags);

    document.getElementById("summaryBox").textContent = buildSummaryText();

    const recs = collectRecommendations();
    document.getElementById("recBox").textContent = formatRecsText(recs);

    if(document.getElementById("autosave").checked){
      save();
    }
  }

  // =========================================================
  // PDF footer helper
  // =========================================================
  function pdfFooter(doc, pageNo, totalPages){
    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    const w = doc.internal.pageSize.getWidth();
    const h = doc.internal.pageSize.getHeight();
    doc.text(COPYRIGHT, 40, h - 28);
    doc.text(`Page ${pageNo} / ${totalPages}`, w - 90, h - 28);
  }

  // =========================================================
  // PDF export
  // =========================================================
  function pdfExport(){
    const data = collectAll();
    const recs = collectRecommendations();
    const recText = formatRecsText(recs);

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });

    const title = "Runner Readiness Assessment";
    const client = data.meta.clientName || "—";
    const date = data.meta.assessDate || "—";
    const caseId = data.meta.caseId || "—";

    doc.setFont("helvetica", "bold"); doc.setFontSize(16);
    doc.text(title, 40, 54);
    doc.setFont("helvetica", "normal"); doc.setFontSize(11);
    doc.text(`Client: ${client}`, 40, 76);
    doc.text(`Date: ${date}`, 40, 92);
    doc.text(`Case ID: ${caseId}`, 40, 108);

    // Waiver / History table
    const w = data.waiver || {};
    const waiverRows = [
      ["Years running", w.yearsRunning || ""],
      ["Runs/week", w.runsPerWeek || ""],
      ["Mileage/week (km)", w.mileagePerWeek || ""],
      ["Goals", w.runningGoals || ""],
      ["MSK injury history", w.mskHistory || ""],
      ["Stress fracture", w.stressFracture || ""],
      ["Medical clearance", w.medicalClearance || ""],
      ["Accuracy confirmed", w.waiverAccurate || ""],
      ["Proceed with assessment", w.waiverProceed || ""],
      ["Signature", w.clientSignature || ""],
      ["Signature date", w.signatureDate || ""]
    ];

    doc.autoTable({
      startY: 126,
      head: [["Training History & Waiver", "Details"]],
      body: waiverRows,
      styles: { font: "helvetica", fontSize: 9, cellPadding: 4, valign:"top" },
      headStyles: { fillColor: [30, 40, 70] },
      theme: "grid",
      margin: { left: 40, right: 40 },
      columnStyles: { 0: { cellWidth: 170 }, 1: { cellWidth: 345 } }
    });

    // Gait Findings
    const gf = (STATE.gaitFindings || []).join(", ");
    const gfNotes = getVal("gaitFindingsNotes");
    doc.autoTable({
      startY: doc.lastAutoTable.finalY + 14,
      head: [["Gait Analysis Findings", "Details"]],
      body: [
        ["Tags", gf || ""],
        ["Notes", gfNotes || ""]
      ],
      styles: { font: "helvetica", fontSize: 9, cellPadding: 4, valign:"top" },
      headStyles: { fillColor: [30, 40, 70] },
      theme: "grid",
      margin: { left: 40, right: 40 },
      columnStyles: { 0: { cellWidth: 170 }, 1: { cellWidth: 345 } }
    });

    // Movement table
    const mvHead = ["Movement Metric","Able","Unable","Limitations (if unable)"];
    const mvBody = MOVEMENT.map(m => {
      const able = getToggle(`mv__${m.key}__able`) ? "✓" : "";
      const unable = getToggle(`mv__${m.key}__unable`) ? "✓" : "";
      const limits = (getToggle(`mv__${m.key}__unable`) ? (STATE.movementLimits[m.key] || []).join(", ") : "");
      return [m.label, able, unable, limits];
    });

    doc.autoTable({
      startY: doc.lastAutoTable.finalY + 14,
      head: [mvHead],
      body: mvBody,
      styles: { font: "helvetica", fontSize: 9, cellPadding: 4 },
      headStyles: { fillColor: [30, 40, 70] },
      theme: "grid",
      margin: { left: 40, right: 40 }
    });

    // Strength table
    const stHead = ["Strength & Stability","Able (L)","Able (R)","Unable (L)","Unable (R)"];
    const stBody = STRENGTH.map(it => ([
      it.label,
      getToggle(`st__${it.key}__able__L`) ? "✓" : "",
      getToggle(`st__${it.key}__able__R`) ? "✓" : "",
      getToggle(`st__${it.key}__unable__L`) ? "✓" : "",
      getToggle(`st__${it.key}__unable__R`) ? "✓" : ""
    ]));

    doc.autoTable({
      startY: doc.lastAutoTable.finalY + 14,
      head: [stHead],
      body: stBody,
      styles: { font: "helvetica", fontSize: 9, cellPadding: 4 },
      headStyles: { fillColor: [30, 40, 70] },
      theme: "grid",
      margin: { left: 40, right: 40 }
    });

    // Foot table
    const ftHead = ["Foot Assessment","Able (L)","Able (R)","Unable (L)","Unable (R)"];
    const ftBody = FOOT.map(it => ([
      it.label,
      getToggle(`ft__${it.key}__able__L`) ? "✓" : "",
      getToggle(`ft__${it.key}__able__R`) ? "✓" : "",
      getToggle(`ft__${it.key}__unable__L`) ? "✓" : "",
      getToggle(`ft__${it.key}__unable__R`) ? "✓" : ""
    ]));

    doc.autoTable({
      startY: doc.lastAutoTable.finalY + 14,
      head: [ftHead],
      body: ftBody,
      styles: { font: "helvetica", fontSize: 9, cellPadding: 4 },
      headStyles: { fillColor: [30, 40, 70] },
      theme: "grid",
      margin: { left: 40, right: 40 }
    });

    // Ankle ROM
    const ankHead = ["Ankle ROM (Limited)","Left","Right"];
    const ankBody = ANKLE_ROM.map(r => ([
      r.label,
      getToggle(`ank__${r.key}__L`) ? "✓" : "",
      getToggle(`ank__${r.key}__R`) ? "✓" : ""
    ]));

    doc.autoTable({
      startY: doc.lastAutoTable.finalY + 14,
      head: [ankHead],
      body: ankBody,
      styles: { font: "helvetica", fontSize: 9, cellPadding: 4 },
      headStyles: { fillColor: [30, 40, 70] },
      theme: "grid",
      margin: { left: 40, right: 40 }
    });

    // Recommendations page
    doc.addPage();
    doc.setFont("helvetica", "bold"); doc.setFontSize(13);
    doc.text("Recommended Mobility / Stability Exercises", 40, 60);
    doc.setFont("helvetica", "normal"); doc.setFontSize(10);
    doc.text(doc.splitTextToSize(recText, 515), 40, 84);

    // Summary page
    doc.addPage();
    doc.setFont("helvetica", "bold"); doc.setFontSize(13);
    doc.text("Summary", 40, 60);
    doc.setFont("helvetica", "normal"); doc.setFontSize(10);
    const summary = buildSummaryText();
    doc.text(doc.splitTextToSize(summary, 515), 40, 84);

    // Footer on all pages
    const total = doc.getNumberOfPages();
    for(let p=1; p<=total; p++){
      doc.setPage(p);
      pdfFooter(doc, p, total);
    }

    const base = ((caseId !== "—" ? caseId : (client !== "—" ? client : "assessment"))).replace(/[^\w\-]+/g, "_");
    doc.save(`${base}_runner_readiness_${new Date().toISOString().slice(0,10)}.pdf`);
  }

  // =========================================================
  // XLSX export
  // =========================================================
  function xlsxExport(){
    const data = collectAll();
    const recs = collectRecommendations();
    const wb = XLSX.utils.book_new();

    // Meta
    const metaRows = [
      ["Runner Readiness Assessment"],
      ["Client Name", data.meta.clientName || ""],
      ["Assessment Date", data.meta.assessDate || ""],
      ["Case ID", data.meta.caseId || ""],
      ["Saved At (ISO)", data.meta.savedAtISO || ""],
      [],
      ["Copyright", COPYRIGHT]
    ];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(metaRows), "Meta");

    // Waiver
    const w = data.waiver || {};
    const waiverAoa = [
      ["Training History & Waiver", ""],
      ["Years running", w.yearsRunning || ""],
      ["Runs/week", w.runsPerWeek || ""],
      ["Mileage/week (km)", w.mileagePerWeek || ""],
      ["Goals", w.runningGoals || ""],
      ["MSK injury history", w.mskHistory || ""],
      ["Stress fracture", w.stressFracture || ""],
      ["Medical clearance", w.medicalClearance || ""],
      ["Accuracy confirmed", w.waiverAccurate || ""],
      ["Proceed with assessment", w.waiverProceed || ""],
      ["Signature", w.clientSignature || ""],
      ["Signature date", w.signatureDate || ""]
    ];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(waiverAoa), "Waiver");

    // Gait Findings sheet
    const gfAoa = [
      ["Gait Analysis Findings", ""],
      ["Tags", (STATE.gaitFindings || []).join(", ")],
      ["Notes", getVal("gaitFindingsNotes") || ""],
      [],
      ["Copyright", COPYRIGHT]
    ];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(gfAoa), "Gait Findings");

    // Movement
    const mvAoa = [["Metric","Able","Unable","Limitations (if unable)"]];
    MOVEMENT.forEach(m => {
      mvAoa.push([
        m.label,
        getToggle(`mv__${m.key}__able`) ? "Yes" : "",
        getToggle(`mv__${m.key}__unable`) ? "Yes" : "",
        (getToggle(`mv__${m.key}__unable`) ? (STATE.movementLimits[m.key] || []).join(", ") : "")
      ]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(mvAoa), "Movement");

    // Strength
    const stAoa = [["Metric","Able (L)","Able (R)","Unable (L)","Unable (R)"]];
    STRENGTH.forEach(it => {
      stAoa.push([
        it.label,
        getToggle(`st__${it.key}__able__L`) ? "Yes" : "",
        getToggle(`st__${it.key}__able__R`) ? "Yes" : "",
        getToggle(`st__${it.key}__unable__L`) ? "Yes" : "",
        getToggle(`st__${it.key}__unable__R`) ? "Yes" : ""
      ]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(stAoa), "Strength");

    // Foot
    const ftAoa = [["Metric","Able (L)","Able (R)","Unable (L)","Unable (R)"]];
    FOOT.forEach(it => {
      ftAoa.push([
        it.label,
        getToggle(`ft__${it.key}__able__L`) ? "Yes" : "",
        getToggle(`ft__${it.key}__able__R`) ? "Yes" : "",
        getToggle(`ft__${it.key}__unable__L`) ? "Yes" : "",
        getToggle(`ft__${it.key}__unable__R`) ? "Yes" : ""
      ]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ftAoa), "Foot");

    // Ankle ROM
    const ankAoa = [["Motion (Limited)","Left","Right"]];
    ANKLE_ROM.forEach(r => {
      ankAoa.push([
        r.label,
        getToggle(`ank__${r.key}__L`) ? "Yes" : "",
        getToggle(`ank__${r.key}__R`) ? "Yes" : ""
      ]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ankAoa), "Ankle ROM");

    // Recommendations
    const recAoa = [
      ["Recommended Mobility / Stability Exercises", ""],
      [],
      ["Mobility focus", ""],
      ...(recs.mobility.length ? recs.mobility.map(x => ["- " + x, ""]) : [["- (none)", ""]]),
      [],
      ["Stability / Control focus", ""],
      ...(recs.stability.length ? recs.stability.map(x => ["- " + x, ""]) : [["- (none)", ""]]),
      [],
      ["Triggers", ""],
      ...(recs.notes.length ? recs.notes.map(x => ["- " + x, ""]) : [["- (none)", ""]]),
      [],
      ["Programming hint", ""],
      ["- Choose 2–4 drills total, 2–4×/week. Keep pain-free, progress gradually.", ""],
      [],
      ["Copyright", COPYRIGHT]
    ];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(recAoa), "Recommendations");

    // Notes + Summary
    const nsAoa = [
      ["Coach Notes"],
      [getVal("notes") || ""],
      [],
      ["Auto Summary"],
      [buildSummaryText()],
      [],
      ["Copyright"],
      [COPYRIGHT]
    ];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(nsAoa), "Notes & Summary");

    const client = data.meta.clientName || "assessment";
    const caseId = data.meta.caseId || "";
    const base = (caseId || client).replace(/[^\w\-]+/g, "_");
    XLSX.writeFile(wb, `${base}_runner_readiness_${new Date().toISOString().slice(0,10)}.xlsx`);
  }

  // =========================================================
  // Wire up
  // =========================================================
  function wire(){
    document.getElementById("btnSave").addEventListener("click", save);
    document.getElementById("btnLoad").addEventListener("click", load);
    document.getElementById("btnPdf").addEventListener("click", pdfExport);
    document.getElementById("btnXlsx").addEventListener("click", xlsxExport);
    document.getElementById("btnPrint").addEventListener("click", () => window.print());
    document.getElementById("btnReset").addEventListener("click", resetAll);

    const autosave = document.getElementById("autosave");
    const autosavePill = document.getElementById("autosavePill");
    autosave.addEventListener("change", () => {
      autosavePill.textContent = `Autosave: ${autosave.checked ? "On" : "Off"}`;
      if(autosave.checked) save();
    });

    document.addEventListener("input", onAnyChange);
    document.addEventListener("change", onAnyChange);
  }

  function init(){
    document.getElementById("yr").textContent = new Date().getFullYear();

    document.getElementById("assessDate").value = new Date().toISOString().slice(0,10);
    document.getElementById("signatureDate").value = new Date().toISOString().slice(0,10);

    buildMovementTable();
    buildLRTable("strengthTable", "st", STRENGTH);
    buildLRTable("footTable", "ft", FOOT);
    buildAnkleBlock();
    buildGaitFindings();

    wire();
    onAnyChange();

    // try auto-load if autosave was on previously (optional)
  }

  init();
</script>
</body>
</html>
