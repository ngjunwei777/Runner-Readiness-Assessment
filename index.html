<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Runner Readiness Assessment - Gait Coach App</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --muted:#a9b4cc;
      --text:#eef3ff;
      --line:rgba(255,255,255,.10);
      --accent:#3dd6d0;
      --accent2:#7aa6ff;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --good:#4ee59b;
      --shadow: 0 10px 35px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 15% 10%, rgba(61,214,208,.18), transparent 55%),
                  radial-gradient(900px 600px at 85% 20%, rgba(122,166,255,.18), transparent 55%),
                  linear-gradient(180deg, #070b14 0%, var(--bg) 55%, #070b14 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(7,11,20,.92), rgba(7,11,20,.65));
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px;}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(61,214,208,.95), rgba(122,166,255,.85));
      box-shadow: var(--shadow);
    }
    h1{font-size:18px;margin:0;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12.5px;margin-top:2px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s ease;
    }
    button:hover{transform: translateY(-1px); background: rgba(255,255,255,.10)}
    button.primary{
      border-color: rgba(61,214,208,.35);
      background: rgba(61,214,208,.16);
    }
    button.danger{
      border-color: rgba(255,107,107,.35);
      background: rgba(255,107,107,.14);
    }

    main{max-width:1100px;margin:0 auto;padding:18px 16px 80px;}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} header{position:relative} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .card .hd h2{margin:0;font-size:14.5px;letter-spacing:.2px}
    .pill{
      font-size:12px;color:var(--muted);
      padding:6px 10px;border:1px solid var(--line);border-radius:999px;
      background: rgba(255,255,255,.04);
    }
    .card .bd{padding:14px}

    .sectionTitle{
      margin:16px 0 10px;
      font-size:12px;
      color: var(--muted);
      letter-spacing:.14em;
      text-transform:uppercase;
    }
    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 680px){ .twoCol{grid-template-columns:1fr} }

    input[type="text"], input[type="date"], textarea{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(10,16,30,.65);
      color: var(--text);
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical}

    .hr{height:1px;background:var(--line);margin:12px 0;}

    /* Table */
    .tbl{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.03);
    }
    .tbl th, .tbl td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      border-right:1px solid var(--line);
      vertical-align:middle;
      font-size:13px;
    }
    .tbl th:last-child, .tbl td:last-child{border-right:none}
    .tbl tr:last-child td{border-bottom:none}
    .tbl thead th{
      position:sticky; top:0;
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight:600;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .metricCell{
      font-weight:600;
      color: var(--text);
      width: 220px;
      min-width: 180px;
      background: rgba(255,255,255,.02);
    }

    .checkWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    input[type="checkbox"]{
      width:18px;height:18px;
      accent-color: var(--accent);
      cursor:pointer;
    }
    .mini{
      font-size:12px;color:var(--muted);
    }

    .kpi{
      display:grid; grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 680px){ .kpi{grid-template-columns:1fr} }
    .stat{
      padding:12px;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.04);
    }
    .stat b{display:block;font-size:18px;margin-bottom:2px}
    .stat span{color:var(--muted);font-size:12px}

    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      margin: 6px 6px 0 0;
      font-size:12.5px;
    }
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}
    .dot.good{background:var(--good)}

    .summaryBox{
      padding:12px;
      border:1px dashed rgba(255,255,255,.20);
      border-radius:16px;
      background: rgba(255,255,255,.03);
      white-space: pre-wrap;
      line-height:1.35;
      font-size:13px;
    }
    .footnote{color:var(--muted);font-size:12px;margin-top:8px;}
    .inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Runner Readiness Assessment</h1>
          <div class="sub">Checkbox columns • Left/Right sides • Movement • Strength & Stability • Foot</div>
        </div>
      </div>
      <div class="actions">
        <button class="primary" id="btnSave">Save</button>
        <button id="btnLoad">Load</button>
        <button id="btnExport">Export JSON</button>
        <button id="btnPrint">Print</button>
        <button class="danger" id="btnReset">Reset</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <!-- LEFT: FORM -->
    <section class="card">
      <div class="hd">
        <h2>Assessment Form</h2>
        <span class="pill" id="autosavePill">Autosave: Off</span>
      </div>
      <div class="bd">

        <div class="sectionTitle">Client details</div>
        <div class="twoCol">
          <div>
            <label class="mini">Client Name</label>
            <input type="text" id="clientName" placeholder="e.g., Alex Tan" />
          </div>
          <div>
            <label class="mini">Assessment Date</label>
            <input type="date" id="assessDate" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="sectionTitle">Movement</div>
        <div id="movementTable"></div>

        <div class="hr"></div>

        <div class="sectionTitle">Strength & Stability</div>
        <div id="strengthTable"></div>

        <div class="hr"></div>

        <div class="sectionTitle">Foot Assessment</div>
        <div id="footTable"></div>

        <div class="hr"></div>

        <div class="sectionTitle">Ankle ROM (Inability)</div>
        <div id="ankleRomTable"></div>
        <div class="footnote">Tick L/R if the client shows inability in the listed ankle ROM pattern.</div>

        <div class="hr"></div>

        <div class="sectionTitle">Coach notes</div>
        <textarea id="notes" placeholder="Key observations, cues, priorities, plan..."></textarea>

      </div>
    </section>

    <!-- RIGHT: SUMMARY -->
    <aside class="card">
      <div class="hd">
        <h2>Summary & Flags</h2>
        <span class="pill" id="lastSaved">Not saved yet</span>
      </div>
      <div class="bd">
        <div class="kpi">
          <div class="stat">
            <b id="kpiChecked">0</b>
            <span>Total checks</span>
          </div>
          <div class="stat">
            <b id="kpiLeft">0</b>
            <span>Left checks</span>
          </div>
          <div class="stat">
            <b id="kpiRight">0</b>
            <span>Right checks</span>
          </div>
        </div>

        <div class="sectionTitle">Quick flags</div>
        <div id="flagTags"></div>

        <div class="sectionTitle">Auto-generated summary</div>
        <div class="summaryBox" id="summaryBox">Tick the checkboxes to generate a summary.</div>

        <div class="sectionTitle">Data management</div>
        <div class="inline">
          <label class="tag" title="Toggle automatic saving to this browser">
            <input type="checkbox" id="autosave" />
            Autosave to device
          </label>
          <label class="tag" title="Optional: give this assessment a simple ID">
            <span style="color:var(--muted)">Case ID</span>
            <input type="text" id="caseId" placeholder="e.g., AT-2026-01-06"
              style="width:180px;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background: rgba(10,16,30,.65);color:var(--text);" />
          </label>
        </div>
        <div class="footnote">
          Save/Load uses browser localStorage (works on GitHub Pages). Export downloads a JSON file.
        </div>
      </div>
    </aside>

  </div>
</main>

<script>
  // =========================================================
  // CONFIG: Metrics + checkbox columns (Left/Right)
  // =========================================================
  const MOVEMENT = [
    { key: "toe_touch", label: "Toe Touch" },
    { key: "back_bend", label: "Back Bend" },
    { key: "rotation", label: "Rotation" },
    { key: "single_leg_balance", label: "Single Leg Balance" },
    { key: "squat", label: "Squat" }
  ];

  // Column checkboxes shown in the picture-style layout
  // We implement them as: Able, Unable, Limitation (and Limitation has L/R).
  // Able/Unable are not side-specific; Limitation is side-specific.
  const MOVEMENT_COLUMNS = [
    { key: "able", label: "Able", sides: false },
    { key: "unable", label: "Unable", sides: false },
    { key: "limitation", label: "Limitation", sides: true } // L/R
  ];

  const STRENGTH = [
    { key: "bridge", label: "Bridge" },
    { key: "side_plank", label: "Side Plank" },
    { key: "sl_sit_to_stand", label: "Single Leg Sit-to-Stand" },
    { key: "calf_raise", label: "Calf Raise" }
  ];

  const STRENGTH_COLUMNS = [
    { key: "able", label: "Able", sides: true },   // L/R
    { key: "unable", label: "Unable", sides: true } // L/R
  ];

  const FOOT = [
    { key: "toe_splay", label: "Toe Splay" },
    { key: "great_toe_extension", label: "Great Toe Extension" },
    { key: "great_toe_abduction", label: "Great Toe Abduction" }
  ];

  const FOOT_COLUMNS = [
    { key: "able", label: "Able", sides: true },   // L/R
    { key: "unable", label: "Unable", sides: true } // L/R
  ];

  const ANKLE_ROM_INABILITY = [
    { key: "eversion", label: "Eversion inability" },
    { key: "inversion", label: "Inversion inability" },
    { key: "supination", label: "Supination inability" },
    { key: "pronation", label: "Pronation inability" }
  ];

  // =========================================================
  // UI Builders
  // =========================================================
  function el(tag, attrs={}, children=[]){
    const n = document.createElement(tag);
    for(const [k,v] of Object.entries(attrs)){
      if(k === "class") n.className = v;
      else if(k === "html") n.innerHTML = v;
      else n.setAttribute(k, v);
    }
    children.forEach(c => n.appendChild(c));
    return n;
  }

  function makeCheckbox(id){
    const cb = el("input", { type:"checkbox", id });
    cb.addEventListener("change", onAnyChange);
    return cb;
  }

  function buildTable(containerId, titleKey, metrics, columns){
    const table = el("table", { class:"tbl", "data-table": titleKey });

    // header
    const thead = el("thead");
    const trh = el("tr");

    trh.appendChild(el("th", { class:"metricCell", html:"Metric" }));

    columns.forEach(col => {
      if(col.sides){
        trh.appendChild(el("th", { html: `${escapeHtml(col.label)}<div class="mini">L</div>` }));
        trh.appendChild(el("th", { html: `${escapeHtml(col.label)}<div class="mini">R</div>` }));
      }else{
        trh.appendChild(el("th", { html: escapeHtml(col.label) }));
      }
    });

    thead.appendChild(trh);
    table.appendChild(thead);

    // body
    const tbody = el("tbody");
    metrics.forEach(m => {
      const tr = el("tr");
      tr.appendChild(el("td", { class:"metricCell", html: escapeHtml(m.label) }));

      columns.forEach(col => {
        if(col.sides){
          // Left
          const idL = `${titleKey}__${m.key}__${col.key}__L`;
          const tdL = el("td");
          tdL.appendChild(el("div", { class:"checkWrap" }, [makeCheckbox(idL)]));
          tr.appendChild(tdL);

          // Right
          const idR = `${titleKey}__${m.key}__${col.key}__R`;
          const tdR = el("td");
          tdR.appendChild(el("div", { class:"checkWrap" }, [makeCheckbox(idR)]));
          tr.appendChild(tdR);
        }else{
          const id = `${titleKey}__${m.key}__${col.key}`;
          const td = el("td");
          td.appendChild(el("div", { class:"checkWrap" }, [makeCheckbox(id)]));
          tr.appendChild(td);
        }
      });

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);

    const container = document.getElementById(containerId);
    container.innerHTML = "";
    container.appendChild(table);
  }

  function buildAnkleRomTable(){
    const table = el("table", { class:"tbl", "data-table":"ankle" });

    const thead = el("thead");
    const trh = el("tr");
    trh.appendChild(el("th", { class:"metricCell", html:"Ankle ROM Pattern (Inability)" }));
    trh.appendChild(el("th", { html:"Left" }));
    trh.appendChild(el("th", { html:"Right" }));
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = el("tbody");
    ANKLE_ROM_INABILITY.forEach(r => {
      const tr = el("tr");
      tr.appendChild(el("td", { class:"metricCell", html: escapeHtml(r.label) }));

      const idL = `ankle__${r.key}__L`;
      const tdL = el("td");
      tdL.appendChild(el("div", { class:"checkWrap" }, [makeCheckbox(idL)]));
      tr.appendChild(tdL);

      const idR = `ankle__${r.key}__R`;
      const tdR = el("td");
      tdR.appendChild(el("div", { class:"checkWrap" }, [makeCheckbox(idR)]));
      tr.appendChild(tdR);

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    const container = document.getElementById("ankleRomTable");
    container.innerHTML = "";
    container.appendChild(table);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // =========================================================
  // Data handling
  // =========================================================
  const STORAGE_KEY = "runner_readiness_assessment_checkbox_v2";

  function collectAll(){
    const data = {
      meta: {
        clientName: getVal("clientName"),
        assessDate: getVal("assessDate"),
        caseId: getVal("caseId"),
        savedAtISO: new Date().toISOString()
      },
      notes: getVal("notes"),
      movement: collectTable("movement", MOVEMENT, MOVEMENT_COLUMNS),
      strength: collectTable("strength", STRENGTH, STRENGTH_COLUMNS),
      foot: collectTable("foot", FOOT, FOOT_COLUMNS),
      ankle: collectAnkle()
    };
    return data;
  }

  function collectTable(prefix, metrics, columns){
    const rows = {};
    metrics.forEach(m => {
      rows[m.key] = {};
      columns.forEach(col => {
        if(col.sides){
          rows[m.key][`${col.key}_L`] = getChecked(`${prefix}__${m.key}__${col.key}__L`);
          rows[m.key][`${col.key}_R`] = getChecked(`${prefix}__${m.key}__${col.key}__R`);
        }else{
          rows[m.key][col.key] = getChecked(`${prefix}__${m.key}__${col.key}`);
        }
      });
    });
    return rows;
  }

  function collectAnkle(){
    const out = {};
    ANKLE_ROM_INABILITY.forEach(r => {
      out[r.key] = {
        L: getChecked(`ankle__${r.key}__L`),
        R: getChecked(`ankle__${r.key}__R`)
      };
    });
    return out;
  }

  function applyAll(data){
    if(!data) return;

    setVal("clientName", data?.meta?.clientName || "");
    setVal("assessDate", data?.meta?.assessDate || "");
    setVal("caseId", data?.meta?.caseId || "");
    setVal("notes", data?.notes || "");

    applyTable("movement", MOVEMENT, MOVEMENT_COLUMNS, data?.movement || {});
    applyTable("strength", STRENGTH, STRENGTH_COLUMNS, data?.strength || {});
    applyTable("foot", FOOT, FOOT_COLUMNS, data?.foot || {});
    applyAnkle(data?.ankle || {});

    updateSavedPill(data?.meta?.savedAtISO || null);
    updateSummary();
  }

  function applyTable(prefix, metrics, columns, saved){
    metrics.forEach(m => {
      const row = saved[m.key] || {};
      columns.forEach(col => {
        if(col.sides){
          setChecked(`${prefix}__${m.key}__${col.key}__L`, !!row[`${col.key}_L`]);
          setChecked(`${prefix}__${m.key}__${col.key}__R`, !!row[`${col.key}_R`]);
        }else{
          setChecked(`${prefix}__${m.key}__${col.key}`, !!row[col.key]);
        }
      });
    });
  }

  function applyAnkle(saved){
    ANKLE_ROM_INABILITY.forEach(r => {
      setChecked(`ankle__${r.key}__L`, !!saved?.[r.key]?.L);
      setChecked(`ankle__${r.key}__R`, !!saved?.[r.key]?.R);
    });
  }

  function getVal(id){ return (document.getElementById(id)?.value ?? "").trim(); }
  function setVal(id, v){ const el = document.getElementById(id); if(el) el.value = v; }
  function getChecked(id){ return !!document.getElementById(id)?.checked; }
  function setChecked(id, v){ const el = document.getElementById(id); if(el) el.checked = !!v; }

  // =========================================================
  // Summary + Flags
  // =========================================================
  function updateSummary(){
    // Count checks
    const allChecks = [...document.querySelectorAll("input[type='checkbox']")];
    const checked = allChecks.filter(x => x.checked);
    const left = checked.filter(x => x.id.endsWith("__L") || x.id.endsWith("_L") || x.id.endsWith("__L")).length;
    const right = checked.filter(x => x.id.endsWith("__R") || x.id.endsWith("_R") || x.id.endsWith("__R")).length;

    document.getElementById("kpiChecked").textContent = checked.length;
    document.getElementById("kpiLeft").textContent = left;
    document.getElementById("kpiRight").textContent = right;

    // Build flags (mostly unable/inability and limitations)
    const tags = [];

    // Movement flags: unable or limitation sides
    MOVEMENT.forEach(m => {
      const unable = getChecked(`movement__${m.key}__unable`);
      const limL = getChecked(`movement__${m.key}__limitation__L`);
      const limR = getChecked(`movement__${m.key}__limitation__R`);
      if(unable) tags.push({text:`Movement: ${m.label} = Unable`, level:"bad"});
      if(limL || limR){
        tags.push({text:`Movement: ${m.label} limitation (${sideText(limL, limR)})`, level:"warn"});
      }
    });

    // Strength flags: unable L/R
    STRENGTH.forEach(m => {
      const uL = getChecked(`strength__${m.key}__unable__L`);
      const uR = getChecked(`strength__${m.key}__unable__R`);
      if(uL || uR) tags.push({text:`Strength: ${m.label} unable (${sideText(uL,uR)})`, level:"bad"});
    });

    // Foot flags: unable L/R
    FOOT.forEach(m => {
      const uL = getChecked(`foot__${m.key}__unable__L`);
      const uR = getChecked(`foot__${m.key}__unable__R`);
      if(uL || uR) tags.push({text:`Foot: ${m.label} unable (${sideText(uL,uR)})`, level:"bad"});
    });

    // Ankle inability flags
    ANKLE_ROM_INABILITY.forEach(r => {
      const iL = getChecked(`ankle__${r.key}__L`);
      const iR = getChecked(`ankle__${r.key}__R`);
      if(iL || iR) tags.push({text:`Ankle ROM: ${r.label} (${sideText(iL,iR)})`, level:"bad"});
    });

    renderTags(tags);

    // Summary text
    const data = collectAll();
    const lines = [];
    const header = [data.meta.clientName || "Client", data.meta.assessDate || "Date not set"].filter(Boolean).join(" • ");
    lines.push(header);
    lines.push("");

    lines.push("Movement");
    MOVEMENT.forEach(m => {
      const a = getChecked(`movement__${m.key}__able`);
      const u = getChecked(`movement__${m.key}__unable`);
      const lL = getChecked(`movement__${m.key}__limitation__L`);
      const lR = getChecked(`movement__${m.key}__limitation__R`);
      if(a || u || lL || lR){
        lines.push(`- ${m.label}: ${a ? "Able" : ""}${(a && u) ? " + " : ""}${u ? "Unable" : ""}${(lL||lR) ? ` | Limitation: ${sideText(lL,lR)}` : ""}`);
      }
    });

    lines.push("");
    lines.push("Strength & Stability");
    STRENGTH.forEach(m => {
      const aL = getChecked(`strength__${m.key}__able__L`);
      const aR = getChecked(`strength__${m.key}__able__R`);
      const uL = getChecked(`strength__${m.key}__unable__L`);
      const uR = getChecked(`strength__${m.key}__unable__R`);
      if(aL || aR || uL || uR){
        lines.push(`- ${m.label}: Able(${sideText(aL,aR)}) | Unable(${sideText(uL,uR)})`);
      }
    });

    lines.push("");
    lines.push("Foot Assessment");
    FOOT.forEach(m => {
      const aL = getChecked(`foot__${m.key}__able__L`);
      const aR = getChecked(`foot__${m.key}__able__R`);
      const uL = getChecked(`foot__${m.key}__unable__L`);
      const uR = getChecked(`foot__${m.key}__unable__R`);
      if(aL || aR || uL || uR){
        lines.push(`- ${m.label}: Able(${sideText(aL,aR)}) | Unable(${sideText(uL,uR)})`);
      }
    });

    lines.push("");
    lines.push("Ankle ROM (Inability)");
    ANKLE_ROM_INABILITY.forEach(r => {
      const iL = getChecked(`ankle__${r.key}__L`);
      const iR = getChecked(`ankle__${r.key}__R`);
      if(iL || iR){
        lines.push(`- ${r.label}: ${sideText(iL,iR)}`);
      }
    });

    if(data.notes){
      lines.push("");
      lines.push("Coach Notes");
      lines.push(data.notes);
    }

    document.getElementById("summaryBox").textContent = lines.join("\n");
  }

  function sideText(L, R){
    if(L && R) return "L+R";
    if(L) return "L";
    if(R) return "R";
    return "—";
  }

  function renderTags(tags){
    const box = document.getElementById("flagTags");
    box.innerHTML = "";
    if(!tags.length){
      box.innerHTML = `<span class="sub">No flags yet. Tick “Unable”, “Limitation”, or ankle ROM inability.</span>`;
      return;
    }
    tags.slice(0, 16).forEach(t => {
      const span = document.createElement("span");
      span.className = "tag";
      const dot = document.createElement("span");
      dot.className = `dot ${t.level}`;
      span.appendChild(dot);
      span.appendChild(document.createTextNode(t.text));
      box.appendChild(span);
    });
    if(tags.length > 16){
      const more = document.createElement("div");
      more.className = "footnote";
      more.textContent = `+ ${tags.length - 16} more… (see summary)`;
      box.appendChild(more);
    }
  }

  function updateSavedPill(iso){
    const pill = document.getElementById("lastSaved");
    if(!iso){ pill.textContent = "Not saved yet"; return; }
    const d = new Date(iso);
    pill.textContent = `Saved: ${d.toLocaleString()}`;
  }

  // =========================================================
  // Save / Load / Export
  // =========================================================
  function save(){
    const data = collectAll();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    updateSavedPill(data.meta.savedAtISO);
  }

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      alert("No saved assessment found on this device yet.");
      return;
    }
    try{
      const data = JSON.parse(raw);
      applyAll(data);
    }catch(e){
      alert("Saved data was corrupted or unreadable.");
    }
  }

  function resetAll(){
    if(!confirm("Reset the form? This will clear everything on-screen.")) return;
    document.querySelectorAll("input[type='text'], input[type='date'], textarea").forEach(el => el.value = "");
    document.querySelectorAll("input[type='checkbox']").forEach(el => el.checked = false);
    updateSummary();
    updateSavedPill(null);
  }

  function exportJson(){
    const data = collectAll();
    const name = (data.meta.caseId || data.meta.clientName || "assessment").replace(/[^\w\-]+/g, "_");
    const fname = `${name}_runner_readiness_${new Date().toISOString().slice(0,10)}.json`;
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = fname;
    a.click();
    URL.revokeObjectURL(url);
  }

  // =========================================================
  // Events
  // =========================================================
  function onAnyChange(){
    updateSummary();
    if(document.getElementById("autosave").checked){
      save();
    }
  }

  function wire(){
    document.getElementById("btnSave").addEventListener("click", save);
    document.getElementById("btnLoad").addEventListener("click", load);
    document.getElementById("btnExport").addEventListener("click", exportJson);
    document.getElementById("btnPrint").addEventListener("click", () => window.print());
    document.getElementById("btnReset").addEventListener("click", resetAll);

    const autosave = document.getElementById("autosave");
    const autosavePill = document.getElementById("autosavePill");
    autosave.addEventListener("change", () => {
      autosavePill.textContent = `Autosave: ${autosave.checked ? "On" : "Off"}`;
      if(autosave.checked) save();
    });

    // Inputs (text/date/textarea)
    document.addEventListener("input", () => {
      updateSummary();
      if(document.getElementById("autosave").checked){
        save();
      }
    });
  }

  function init(){
    // Build the tables
    buildTable("movementTable", "movement", MOVEMENT, MOVEMENT_COLUMNS);
    buildTable("strengthTable", "strength", STRENGTH, STRENGTH_COLUMNS);
    buildTable("footTable", "foot", FOOT, FOOT_COLUMNS);
    buildAnkleRomTable();

    // default date today
    const iso = new Date().toISOString().slice(0,10);
    document.getElementById("assessDate").value = iso;

    wire();
    updateSummary();
  }

  init();
</script>
</body>
</html>
