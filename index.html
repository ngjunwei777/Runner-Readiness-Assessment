<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Runner Readiness Assessment - Gait Coach App</title>

  <!-- PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- XLSX export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --muted:#a9b4cc;
      --text:#eef3ff;
      --line:rgba(255,255,255,.10);
      --accent:#3dd6d0;
      --accent2:#7aa6ff;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --good:#4ee59b;
      --shadow: 0 10px 35px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 15% 10%, rgba(61,214,208,.18), transparent 55%),
                  radial-gradient(900px 600px at 85% 20%, rgba(122,166,255,.18), transparent 55%),
                  linear-gradient(180deg, #070b14 0%, var(--bg) 55%, #070b14 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(7,11,20,.92), rgba(7,11,20,.65));
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1150px;margin:0 auto;padding:18px 16px;}
    .topbar{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(61,214,208,.95), rgba(122,166,255,.85));
      box-shadow: var(--shadow);
    }
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12.5px;margin-top:2px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s ease;
    }
    button:hover{transform: translateY(-1px); background: rgba(255,255,255,.10)}
    button.primary{border-color: rgba(61,214,208,.35); background: rgba(61,214,208,.16);}
    button.danger{border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.14);}

    main{max-width:1150px;margin:0 auto;padding:18px 16px 80px;}
    .grid{display:grid;grid-template-columns: 1.25fr .75fr;gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} header{position:relative} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .card .hd h2{margin:0;font-size:14.5px}
    .pill{
      font-size:12px;color:var(--muted);
      padding:6px 10px;border:1px solid var(--line);border-radius:999px;
      background: rgba(255,255,255,.04);
    }
    .card .bd{padding:14px}

    .sectionTitle{
      margin:16px 0 10px;
      font-size:12px;
      color: var(--muted);
      letter-spacing:.14em;
      text-transform:uppercase;
    }
    .twoCol{display:grid;grid-template-columns: 1fr 1fr;gap:10px;}
    @media (max-width: 680px){ .twoCol{grid-template-columns:1fr} }

    input[type="text"], input[type="date"], textarea{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(10,16,30,.65);
      color: var(--text);
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    .hr{height:1px;background:var(--line);margin:12px 0;}
    .footnote{color:var(--muted);font-size:12px;margin-top:8px;}
    .inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}

    /* Tables */
    .tbl{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background: rgba(255,255,255,.03);
    }
    .tbl th, .tbl td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      border-right:1px solid var(--line);
      vertical-align:top;
      font-size:13px;
    }
    .tbl th:last-child, .tbl td:last-child{border-right:none}
    .tbl tr:last-child td{border-bottom:none}
    .tbl thead th{
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight:600;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .metricCell{
      font-weight:700;
      width: 220px;
      min-width: 180px;
      background: rgba(255,255,255,.02);
      user-select:none;
    }

    /* Clickable toggle cells */
    .cellToggle{
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, transform .06s ease;
    }
    .cellToggle:hover{background: rgba(255,255,255,.05)}
    .cellToggle:active{transform: scale(.99)}
    .cellToggle.disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .cellCenter{
      display:flex; align-items:center; justify-content:center; min-height:28px;
    }

    /* Faux checkbox UI inside cells */
    .box{
      width:18px;height:18px;border-radius:5px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(10,16,30,.55);
      position:relative;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
    }
    .box.on{
      border-color: rgba(61,214,208,.6);
      background: rgba(61,214,208,.18);
    }
    .box.on::after{
      content:"";
      position:absolute;
      left:5px; top:2px;
      width:5px; height:10px;
      border-right:2px solid var(--accent);
      border-bottom:2px solid var(--accent);
      transform: rotate(40deg);
    }

    /* Limitation chips (multi-select) */
    .chips{display:flex; flex-wrap:wrap; gap:6px;}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-size:12px;
      line-height:1.1;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
    }
    .chip:hover{background: rgba(255,255,255,.07)}
    .chip:active{transform: scale(.99)}
    .chip.on{
      border-color: rgba(255,204,102,.45);
      background: rgba(255,204,102,.14);
    }
    .chip.on .dot{background: var(--warn)}
    .dot{width:8px;height:8px;border-radius:50%;background: rgba(255,255,255,.25)}

    /* Ankle ROM "pleasing looking" buttons */
    .ankleGrid{
      display:grid;
      grid-template-columns: 1fr 110px 110px;
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background: rgba(255,255,255,.03);
    }
    .ankleRow{
      display:contents;
    }
    .ankleHead{
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight:600;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .ankleCell{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      border-right:1px solid var(--line);
      font-size:13px;
    }
    .ankleCell:last-child{border-right:none}
    .ankleRow:last-child .ankleCell{border-bottom:none}
    .ankleLabel{
      display:flex; align-items:center; gap:10px;
      font-weight:700;
      background: rgba(255,255,255,.02);
      user-select:none;
    }
    .glyph{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
      font-size:16px;
    }
    .ankleToggle{
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .sideLbl{font-size:12px;color:var(--muted);margin-left:6px}

    /* Summary side */
    .kpi{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;}
    @media (max-width: 680px){ .kpi{grid-template-columns:1fr} }
    .stat{
      padding:12px;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.04);
    }
    .stat b{display:block;font-size:18px;margin-bottom:2px}
    .stat span{color:var(--muted);font-size:12px}

    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      margin: 6px 6px 0 0;
      font-size:12.5px;
    }
    .dotTag{width:9px;height:9px;border-radius:50%}
    .dotTag.bad{background:var(--bad)}
    .dotTag.warn{background:var(--warn)}
    .dotTag.good{background:var(--good)}
    .summaryBox{
      padding:12px;
      border:1px dashed rgba(255,255,255,.20);
      border-radius:16px;
      background: rgba(255,255,255,.03);
      white-space: pre-wrap;
      line-height:1.35;
      font-size:13px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Runner Readiness Assessment</h1>
          <div class="sub">Movement: tap to toggle Able/Unable • If Unable → multi-select limitations • Export PDF + XLSX</div>
        </div>
      </div>
      <div class="actions">
        <button class="primary" id="btnSave">Save</button>
        <button id="btnLoad">Load</button>
        <button class="primary" id="btnXlsx">Download XLSX</button>
        <button class="primary" id="btnPdf">Download PDF</button>
        <button id="btnPrint">Print</button>
        <button class="danger" id="btnReset">Reset</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <!-- LEFT -->
    <section class="card">
      <div class="hd">
        <h2>Assessment Form</h2>
        <span class="pill" id="autosavePill">Autosave: Off</span>
      </div>
      <div class="bd">

        <div class="sectionTitle">Client details</div>
        <div class="twoCol">
          <div>
            <label class="footnote">Client Name</label>
            <input type="text" id="clientName" placeholder="e.g., Alex Tan" />
          </div>
          <div>
            <label class="footnote">Assessment Date</label>
            <input type="date" id="assessDate" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="sectionTitle">Movement (Able / Unable + Limitations if unable)</div>
        <div id="movementTable"></div>
        <div class="footnote">Tip: “Able” and “Unable” are mutually exclusive. Limitations only activate when “Unable” is selected.</div>

        <div class="hr"></div>

        <div class="sectionTitle">Strength & Stability (L / R)</div>
        <div id="strengthTable"></div>

        <div class="hr"></div>

        <div class="sectionTitle">Foot Assessment (L / R)</div>
        <div id="footTable"></div>

        <div class="hr"></div>

        <div class="sectionTitle">Ankle ROM (Inability) — L / R</div>
        <div id="ankleRomBlock"></div>

        <div class="hr"></div>

        <div class="sectionTitle">Coach notes</div>
        <textarea id="notes" placeholder="Key observations, cues, priorities, plan..."></textarea>

      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <div class="hd">
        <h2>Summary & Flags</h2>
        <span class="pill" id="lastSaved">Not saved yet</span>
      </div>
      <div class="bd">
        <div class="kpi">
          <div class="stat">
            <b id="kpiUnable">0</b>
            <span>Unable selected</span>
          </div>
          <div class="stat">
            <b id="kpiLimit">0</b>
            <span>Limitations selected</span>
          </div>
          <div class="stat">
            <b id="kpiLR">0</b>
            <span>L/R checks</span>
          </div>
        </div>

        <div class="sectionTitle">Quick flags</div>
        <div id="flagTags"></div>

        <div class="sectionTitle">Auto-generated summary</div>
        <div class="summaryBox" id="summaryBox">Fill in the assessment to generate a summary.</div>

        <div class="sectionTitle">Data management</div>
        <div class="inline">
          <label class="tag" title="Toggle automatic saving to this browser">
            <input type="checkbox" id="autosave" />
            Autosave to device
          </label>
          <label class="tag" title="Optional case ID for exports">
            <span style="color:var(--muted)">Case ID</span>
            <input type="text" id="caseId" placeholder="e.g., AT-2026-01-06"
              style="width:180px;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background: rgba(10,16,30,.65);color:var(--text);" />
          </label>
        </div>
        <div class="footnote">Save/Load uses browser localStorage (works on GitHub Pages).</div>
      </div>
    </aside>

  </div>
</main>

<script>
  // =========================================================
  // CONFIG
  // =========================================================
  const MOVEMENT = [
    {
      key: "toe_touch",
      label: "Toe Touch",
      limits: ["Hamstring Tightness","Back Tightness","Core/Back Control","General Limitation"]
    },
    {
      key: "back_bend",
      label: "Back Bend",
      limits: ["Hip Ext Tightness","Back Tightness","Core/Back Control","General Limitation"]
    },
    {
      key: "rotation",
      label: "Rotation",
      limits: ["Hip Tightness","Thoracic Tightness","Hip Rotation Control","Thoracic Rotation Control","General Limitation"]
    },
    {
      key: "single_leg_balance",
      label: "Single Leg Balance",
      limits: ["Foot/Ankle Control","Hip Control"]
    },
    {
      key: "squat",
      label: "Squat",
      limits: ["Ankle Tightness","Hip Tightness","Form/General Limitation"]
    }
  ];

  const STRENGTH = [
    { key: "bridge", label: "Bridge" },
    { key: "side_plank", label: "Side Plank" },
    { key: "sl_sit_to_stand", label: "Single Leg Sit-to-Stand" },
    { key: "calf_raise", label: "Calf Raise" }
  ];

  const FOOT = [
    { key: "toe_splay", label: "Toe Splay" },
    { key: "great_toe_extension", label: "Great Toe Extension" },
    { key: "great_toe_abduction", label: "Great Toe Abduction" }
  ];

  const ANKLE_ROM = [
    { key: "eversion", label: "Eversion inability", glyph: "↗︎" },
    { key: "inversion", label: "Inversion inability", glyph: "↖︎" },
    { key: "supination", label: "Supination inability", glyph: "⤴︎" },
    { key: "pronation", label: "Pronation inability", glyph: "⤵︎" }
  ];

  const STORAGE_KEY = "runner_readiness_assessment_v4";

  // =========================================================
  // DOM helpers
  // =========================================================
  function el(tag, attrs={}, children=[]){
    const n = document.createElement(tag);
    for(const [k,v] of Object.entries(attrs)){
      if(k === "class") n.className = v;
      else if(k === "html") n.innerHTML = v;
      else n.setAttribute(k, v);
    }
    children.forEach(c => n.appendChild(c));
    return n;
  }
  function esc(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  function getVal(id){ return (document.getElementById(id)?.value ?? "").trim(); }
  function setVal(id, v){ const x=document.getElementById(id); if(x) x.value=v; }

  // =========================================================
  // Clickable cell toggles (no native checkbox needed)
  // =========================================================
  function makeToggleCell(id, {disabled=false, onChange=null} = {}){
    const box = el("div", { class: "box", "data-id": id });
    const cell = el("td", { class: `cellToggle${disabled ? " disabled" : ""}`, "data-tid": id, tabindex: "0", role:"button" }, [
      el("div", { class:"cellCenter" }, [box])
    ]);

    setToggleUI(id, false);

    function toggle(){
      if(cell.classList.contains("disabled")) return;
      const next = !getToggleState(id);
      setToggleState(id, next);
      setToggleUI(id, next);
      if(typeof onChange === "function") onChange(next);
      onAnyChange();
    }

    cell.addEventListener("click", toggle);
    cell.addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        toggle();
      }
    });

    return cell;
  }

  function setToggleUI(id, on){
    const box = document.querySelector(`.box[data-id="${cssEsc(id)}"]`);
    if(box) box.classList.toggle("on", !!on);
  }

  // simple state store (in-memory + saved/exported)
  const STATE = { toggles: {}, movementLimits: {} };

  function getToggleState(id){ return !!STATE.toggles[id]; }
  function setToggleState(id, v){ STATE.toggles[id] = !!v; }

  function cssEsc(str){
    // safe for querySelector attr
    return String(str).replace(/"/g, '\\"');
  }

  // =========================================================
  // Movement table: Able/Unable toggle + multi limitation chips when Unable
  // =========================================================
  function buildMovementTable(){
    const table = el("table", { class:"tbl" });
    const thead = el("thead");
    const trh = el("tr");
    trh.appendChild(el("th", { class:"metricCell", html:"Metric" }));
    trh.appendChild(el("th", { html:"Able" }));
    trh.appendChild(el("th", { html:"Unable" }));
    trh.appendChild(el("th", { html:"If Unable: Limitations (multi-select)" }));
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = el("tbody");

    MOVEMENT.forEach(m => {
      const tr = el("tr");

      const metricTd = el("td", { class:"metricCell", html: esc(m.label) });
      metricTd.addEventListener("click", () => {
        const any = getToggleState(`mv__${m.key}__able`) || getToggleState(`mv__${m.key}__unable`) ||
                    ((STATE.movementLimits[m.key] || []).length > 0);
        if(!any) return;
        if(!confirm(`Clear "${m.label}" (Able/Unable + limitations)?`)) return;
        setToggleState(`mv__${m.key}__able`, false);
        setToggleState(`mv__${m.key}__unable`, false);
        setToggleUI(`mv__${m.key}__able`, false);
        setToggleUI(`mv__${m.key}__unable`, false);
        STATE.movementLimits[m.key] = [];
        refreshLimitChips(m.key);
        setLimitCellEnabled(m.key, false);
        onAnyChange();
      });
      tr.appendChild(metricTd);

      // Able cell (mutually exclusive with Unable)
      const ableId = `mv__${m.key}__able`;
      const unableId = `mv__${m.key}__unable`;

      const ableCell = makeToggleCell(ableId, {
        onChange: (on) => {
          if(on){
            // turn off unable
            setToggleState(unableId, false);
            setToggleUI(unableId, false);
            // disable limitations + clear them
            STATE.movementLimits[m.key] = [];
            refreshLimitChips(m.key);
            setLimitCellEnabled(m.key, false);
          }
        }
      });

      const unableCell = makeToggleCell(unableId, {
        onChange: (on) => {
          if(on){
            // turn off able
            setToggleState(ableId, false);
            setToggleUI(ableId, false);
            // enable limitations
            setLimitCellEnabled(m.key, true);
          }else{
            // disable limitations + clear them
            STATE.movementLimits[m.key] = [];
            refreshLimitChips(m.key);
            setLimitCellEnabled(m.key, false);
          }
        }
      });

      tr.appendChild(ableCell);
      tr.appendChild(unableCell);

      // Limitations cell (chips)
      const limitTd = el("td", { id: `mv__${m.key}__limitsCell` });
      limitTd.appendChild(el("div", { class:"chips", id: `mv__${m.key}__chips` }));
      tr.appendChild(limitTd);

      tbody.appendChild(tr);

      // init limitations store
      if(!STATE.movementLimits[m.key]) STATE.movementLimits[m.key] = [];
      renderLimitChips(m);
      setLimitCellEnabled(m.key, false);
    });

    table.appendChild(tbody);

    const container = document.getElementById("movementTable");
    container.innerHTML = "";
    container.appendChild(table);
  }

  function renderLimitChips(m){
    const chipWrap = document.getElementById(`mv__${m.key}__chips`);
    chipWrap.innerHTML = "";
    m.limits.forEach(lab => {
      const chip = el("span", { class:"chip", "data-mkey": m.key, "data-lab": lab }, [
        el("span", { class:"dot" }),
        document.createTextNode(lab)
      ]);
      chip.addEventListener("click", () => {
        const enabled = getToggleState(`mv__${m.key}__unable`);
        if(!enabled) return;

        const selected = new Set(STATE.movementLimits[m.key] || []);
        if(selected.has(lab)) selected.delete(lab);
        else selected.add(lab);

        STATE.movementLimits[m.key] = Array.from(selected);
        refreshLimitChips(m.key);
        onAnyChange();
      });
      chipWrap.appendChild(chip);
    });
    refreshLimitChips(m.key);
  }

  function refreshLimitChips(metricKey){
    const wrap = document.getElementById(`mv__${metricKey}__chips`);
    if(!wrap) return;
    const selected = new Set(STATE.movementLimits[metricKey] || []);
    [...wrap.querySelectorAll(".chip")].forEach(chip => {
      const lab = chip.getAttribute("data-lab");
      chip.classList.toggle("on", selected.has(lab));
    });
  }

  function setLimitCellEnabled(metricKey, enabled){
    const cell = document.getElementById(`mv__${metricKey}__limitsCell`);
    if(!cell) return;
    cell.style.opacity = enabled ? "1" : ".45";
    cell.style.pointerEvents = enabled ? "auto" : "none";
  }

  // =========================================================
  // Strength & Foot tables (L/R Able/Unable clickable cells)
  // =========================================================
  function buildLRTable(containerId, prefix, items){
    const table = el("table", { class:"tbl" });
    const thead = el("thead");
    const trh = el("tr");
    trh.appendChild(el("th", { class:"metricCell", html:"Metric (tap name to clear row)" }));
    trh.appendChild(el("th", { html:"Able (L)" }));
    trh.appendChild(el("th", { html:"Able (R)" }));
    trh.appendChild(el("th", { html:"Unable (L)" }));
    trh.appendChild(el("th", { html:"Unable (R)" }));
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = el("tbody");

    items.forEach(it => {
      const tr = el("tr");

      const metricTd = el("td", { class:"metricCell", html: esc(it.label) });
      metricTd.addEventListener("click", () => {
        const ids = [
          `${prefix}__${it.key}__able__L`,
          `${prefix}__${it.key}__able__R`,
          `${prefix}__${it.key}__unable__L`,
          `${prefix}__${it.key}__unable__R`
        ];
        const any = ids.some(id => getToggleState(id));
        if(!any) return;
        if(!confirm(`Clear "${it.label}" (L/R Able/Unable)?`)) return;
        ids.forEach(id => { setToggleState(id,false); setToggleUI(id,false); });
        onAnyChange();
      });
      tr.appendChild(metricTd);

      // For each side, keep Able/Unable mutually exclusive
      const aL = `${prefix}__${it.key}__able__L`;
      const aR = `${prefix}__${it.key}__able__R`;
      const uL = `${prefix}__${it.key}__unable__L`;
      const uR = `${prefix}__${it.key}__unable__R`;

      tr.appendChild(makeToggleCell(aL, { onChange:(on)=>{ if(on){ setToggleState(uL,false); setToggleUI(uL,false);} } }));
      tr.appendChild(makeToggleCell(aR, { onChange:(on)=>{ if(on){ setToggleState(uR,false); setToggleUI(uR,false);} } }));
      tr.appendChild(makeToggleCell(uL, { onChange:(on)=>{ if(on){ setToggleState(aL,false); setToggleUI(aL,false);} } }));
      tr.appendChild(makeToggleCell(uR, { onChange:(on)=>{ if(on){ setToggleState(aR,false); setToggleUI(aR,false);} } }));

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    container.appendChild(table);
  }

  // =========================================================
  // Ankle ROM (prettier block with glyphs)
  // =========================================================
  function buildAnkleBlock(){
    const grid = el("div", { class:"ankleGrid" });

    // header row
    grid.appendChild(el("div", { class:"ankleCell ankleHead", html:"Ankle motion (inability)" }));
    grid.appendChild(el("div", { class:"ankleCell ankleHead", html:"Left" }));
    grid.appendChild(el("div", { class:"ankleCell ankleHead", html:"Right" }));

    ANKLE_ROM.forEach(r => {
      const label = el("div", { class:"ankleCell ankleLabel" }, [
        el("div", { class:"glyph", html: esc(r.glyph) }),
        el("div", { html: esc(r.label) })
      ]);

      // clicking label clears row
      label.addEventListener("click", () => {
        const idL = `ank__${r.key}__L`;
        const idR = `ank__${r.key}__R`;
        const any = getToggleState(idL) || getToggleState(idR);
        if(!any) return;
        if(!confirm(`Clear "${r.label}" (L/R)?`)) return;
        [idL,idR].forEach(id => { setToggleState(id,false); setToggleUI(id,false); });
        onAnyChange();
      });

      const leftCell = el("div", { class:"ankleCell ankleToggle" });
      const rightCell = el("div", { class:"ankleCell ankleToggle" });

      // use td-like toggle cells but inside div grid
      leftCell.appendChild(makeInlineToggle(`ank__${r.key}__L`));
      rightCell.appendChild(makeInlineToggle(`ank__${r.key}__R`));

      grid.appendChild(label);
      grid.appendChild(leftCell);
      grid.appendChild(rightCell);
    });

    const container = document.getElementById("ankleRomBlock");
    container.innerHTML = "";
    container.appendChild(grid);
  }

  function makeInlineToggle(id){
    const wrap = el("div", { class:"cellToggle", style:"border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:10px;min-width:70px;display:flex;justify-content:center;" });
    const box = el("div", { class:"box", "data-id": id });
    wrap.appendChild(box);

    setToggleUI(id, false);

    function toggle(){
      if(wrap.classList.contains("disabled")) return;
      const next = !getToggleState(id);
      setToggleState(id, next);
      setToggleUI(id, next);
      onAnyChange();
    }

    wrap.addEventListener("click", toggle);
    wrap.tabIndex = 0;
    wrap.addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        toggle();
      }
    });

    return wrap;
  }

  // =========================================================
  // Collect / Apply (for save/load/export)
  // =========================================================
  function collectAll(){
    return {
      meta: {
        clientName: getVal("clientName"),
        assessDate: getVal("assessDate"),
        caseId: getVal("caseId"),
        savedAtISO: new Date().toISOString()
      },
      notes: getVal("notes"),
      toggles: STATE.toggles,
      movementLimits: STATE.movementLimits
    };
  }

  function applyAll(data){
    if(!data) return;

    setVal("clientName", data?.meta?.clientName || "");
    setVal("assessDate", data?.meta?.assessDate || "");
    setVal("caseId", data?.meta?.caseId || "");
    setVal("notes", data?.notes || "");

    // reset state
    STATE.toggles = {};
    STATE.movementLimits = {};

    // restore toggles
    const t = data?.toggles || {};
    for(const [id,v] of Object.entries(t)){
      setToggleState(id, !!v);
      setToggleUI(id, !!v);
    }

    // restore movement limitations
    const ml = data?.movementLimits || {};
    MOVEMENT.forEach(m => {
      STATE.movementLimits[m.key] = Array.isArray(ml[m.key]) ? ml[m.key] : [];
      refreshLimitChips(m.key);
      // enable limitations cell depending on unable
      setLimitCellEnabled(m.key, getToggleState(`mv__${m.key}__unable`));
    });

    updateSavedPill(data?.meta?.savedAtISO || null);
    onAnyChange();
  }

  // =========================================================
  // Save / Load
  // =========================================================
  function updateSavedPill(iso){
    const pill = document.getElementById("lastSaved");
    if(!iso){ pill.textContent = "Not saved yet"; return; }
    pill.textContent = `Saved: ${new Date(iso).toLocaleString()}`;
  }

  function save(){
    const data = collectAll();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    updateSavedPill(data.meta.savedAtISO);
  }

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ alert("No saved assessment found on this device yet."); return; }
    try{ applyAll(JSON.parse(raw)); }
    catch(e){ alert("Saved data was corrupted or unreadable."); }
  }

  function resetAll(){
    if(!confirm("Reset the form? This will clear everything on-screen.")) return;

    setVal("clientName","");
    setVal("caseId","");
    setVal("notes","");
    document.getElementById("assessDate").value = new Date().toISOString().slice(0,10);

    // clear all toggles
    for(const id of Object.keys(STATE.toggles)){
      setToggleState(id,false);
      setToggleUI(id,false);
    }
    STATE.toggles = {};

    // clear limitations
    MOVEMENT.forEach(m => {
      STATE.movementLimits[m.key] = [];
      refreshLimitChips(m.key);
      setLimitCellEnabled(m.key, false);
      // also clear able/unable visuals for movement (in case they were not in STATE keys)
      setToggleUI(`mv__${m.key}__able`, false);
      setToggleUI(`mv__${m.key}__unable`, false);
    });

    updateSavedPill(null);
    onAnyChange();
  }

  // =========================================================
  // Summary & Flags
  // =========================================================
  function sideText(L,R){
    if(L && R) return "L+R";
    if(L) return "L";
    if(R) return "R";
    return "—";
  }

  function renderTags(tags){
    const box = document.getElementById("flagTags");
    box.innerHTML = "";
    if(!tags.length){
      box.innerHTML = `<span class="footnote">No flags yet.</span>`;
      return;
    }
    tags.slice(0, 18).forEach(t => {
      const span = document.createElement("span");
      span.className = "tag";
      const dot = document.createElement("span");
      dot.className = `dotTag ${t.level}`;
      span.appendChild(dot);
      span.appendChild(document.createTextNode(t.text));
      box.appendChild(span);
    });
  }

  function buildSummaryText(){
    const name = getVal("clientName") || "Client";
    const date = getVal("assessDate") || "Date not set";
    const lines = [];
    lines.push(`${name} • ${date}`);
    lines.push("");

    lines.push("Movement");
    MOVEMENT.forEach(m => {
      const able = getToggleState(`mv__${m.key}__able`);
      const unable = getToggleState(`mv__${m.key}__unable`);
      const limits = STATE.movementLimits[m.key] || [];
      if(able || unable || limits.length){
        const status = able ? "Able" : (unable ? "Unable" : "—");
        const lim = (unable && limits.length) ? ` | Limitations: ${limits.join(", ")}` : "";
        lines.push(`- ${m.label}: ${status}${lim}`);
      }
    });

    lines.push("");
    lines.push("Strength & Stability (L/R)");
    STRENGTH.forEach(it => {
      const aL = getToggleState(`st__${it.key}__able__L`);
      const aR = getToggleState(`st__${it.key}__able__R`);
      const uL = getToggleState(`st__${it.key}__unable__L`);
      const uR = getToggleState(`st__${it.key}__unable__R`);
      if(aL||aR||uL||uR){
        lines.push(`- ${it.label}: Able(${sideText(aL,aR)}) | Unable(${sideText(uL,uR)})`);
      }
    });

    lines.push("");
    lines.push("Foot Assessment (L/R)");
    FOOT.forEach(it => {
      const aL = getToggleState(`ft__${it.key}__able__L`);
      const aR = getToggleState(`ft__${it.key}__able__R`);
      const uL = getToggleState(`ft__${it.key}__unable__L`);
      const uR = getToggleState(`ft__${it.key}__unable__R`);
      if(aL||aR||uL||uR){
        lines.push(`- ${it.label}: Able(${sideText(aL,aR)}) | Unable(${sideText(uL,uR)})`);
      }
    });

    lines.push("");
    lines.push("Ankle ROM (Inability) (L/R)");
    ANKLE_ROM.forEach(r => {
      const L = getToggleState(`ank__${r.key}__L`);
      const R = getToggleState(`ank__${r.key}__R`);
      if(L||R){
        lines.push(`- ${r.label}: ${sideText(L,R)}`);
      }
    });

    const notes = getVal("notes");
    if(notes){
      lines.push("");
      lines.push("Coach Notes");
      lines.push(notes);
    }

    return lines.join("\n");
  }

  function onAnyChange(){
    // KPIs
    let unableCount = 0;
    MOVEMENT.forEach(m => { if(getToggleState(`mv__${m.key}__unable`)) unableCount++; });

    let limitCount = 0;
    MOVEMENT.forEach(m => { limitCount += (STATE.movementLimits[m.key] || []).length; });

    let lrCount = 0;
    const lrKeys = [
      ...STRENGTH.flatMap(it => [
        `st__${it.key}__able__L`,`st__${it.key}__able__R`,`st__${it.key}__unable__L`,`st__${it.key}__unable__R`
      ]),
      ...FOOT.flatMap(it => [
        `ft__${it.key}__able__L`,`ft__${it.key}__able__R`,`ft__${it.key}__unable__L`,`ft__${it.key}__unable__R`
      ]),
      ...ANKLE_ROM.flatMap(r => [`ank__${r.key}__L`,`ank__${r.key}__R`])
    ];
    lrKeys.forEach(id => { if(getToggleState(id)) lrCount++; });

    document.getElementById("kpiUnable").textContent = unableCount;
    document.getElementById("kpiLimit").textContent = limitCount;
    document.getElementById("kpiLR").textContent = lrCount;

    // Flags
    const tags = [];

    MOVEMENT.forEach(m => {
      const unable = getToggleState(`mv__${m.key}__unable`);
      const limits = STATE.movementLimits[m.key] || [];
      if(unable) tags.push({ text:`Movement: ${m.label} = Unable`, level:"bad" });
      if(unable && limits.length) tags.push({ text:`${m.label} limitations: ${limits.join(", ")}`, level:"warn" });
    });

    STRENGTH.forEach(it => {
      const uL = getToggleState(`st__${it.key}__unable__L`);
      const uR = getToggleState(`st__${it.key}__unable__R`);
      if(uL||uR) tags.push({ text:`Strength: ${it.label} unable (${sideText(uL,uR)})`, level:"bad" });
    });

    FOOT.forEach(it => {
      const uL = getToggleState(`ft__${it.key}__unable__L`);
      const uR = getToggleState(`ft__${it.key}__unable__R`);
      if(uL||uR) tags.push({ text:`Foot: ${it.label} unable (${sideText(uL,uR)})`, level:"bad" });
    });

    ANKLE_ROM.forEach(r => {
      const L = getToggleState(`ank__${r.key}__L`);
      const R = getToggleState(`ank__${r.key}__R`);
      if(L||R) tags.push({ text:`Ankle ROM: ${r.label} (${sideText(L,R)})`, level:"bad" });
    });

    renderTags(tags);

    // Summary text
    document.getElementById("summaryBox").textContent = buildSummaryText();

    // Autosave
    if(document.getElementById("autosave").checked){
      save();
    }
  }

  // =========================================================
  // PDF export
  // =========================================================
  function pdfExport(){
    const data = collectAll();
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });

    const title = "Runner Readiness Assessment";
    const client = data.meta.clientName || "—";
    const date = data.meta.assessDate || "—";
    const caseId = data.meta.caseId || "—";

    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text(title, 40, 54);

    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.text(`Client: ${client}`, 40, 76);
    doc.text(`Date: ${date}`, 40, 92);
    doc.text(`Case ID: ${caseId}`, 40, 108);

    // Movement table
    const mvHead = ["Movement Metric","Able","Unable","Limitations (if unable)"];
    const mvBody = MOVEMENT.map(m => {
      const able = getToggleState(`mv__${m.key}__able`) ? "✓" : "";
      const unable = getToggleState(`mv__${m.key}__unable`) ? "✓" : "";
      const limits = (getToggleState(`mv__${m.key}__unable`) ? (STATE.movementLimits[m.key] || []).join(", ") : "");
      return [m.label, able, unable, limits];
    });

    doc.autoTable({
      startY: 126,
      head: [mvHead],
      body: mvBody,
      styles: { font: "helvetica", fontSize: 9, cellPadding: 4 },
      headStyles: { fillColor: [30, 40, 70] },
      theme: "grid",
      margin: { left: 40, right: 40 }
    });

    // Strength table
    const stHead = ["Strength & Stability","Able (L)","Able (R)","Unable (L)","Unable (R)"];
    const stBody = STRENGTH.map(it => ([
      it.label,
      getToggleState(`st__${it.key}__able__L`) ? "✓" : "",
      getToggleState(`st__${it.key}__able__R`) ? "✓" : "",
      getToggleState(`st__${it.key}__unable__L`) ? "✓" : "",
      getToggleState(`st__${it.key}__unable__R`) ? "✓" : ""
    ]));

    doc.autoTable({
      startY: doc.lastAutoTable.finalY + 14,
      head: [stHead],
      body: stBody,
      styles: { font: "helvetica", fontSize: 9, cellPadding: 4 },
      headStyles: { fillColor: [30, 40, 70] },
      theme: "grid",
      margin: { left: 40, right: 40 }
    });

    // Foot table
    const ftHead = ["Foot Assessment","Able (L)","Able (R)","Unable (L)","Unable (R)"];
    const ftBody = FOOT.map(it => ([
      it.label,
      getToggleState(`ft__${it.key}__able__L`) ? "✓" : "",
      getToggleState(`ft__${it.key}__able__R`) ? "✓" : "",
      getToggleState(`ft__${it.key}__unable__L`) ? "✓" : "",
      getToggleState(`ft__${it.key}__unable__R`) ? "✓" : ""
    ]));

    doc.autoTable({
      startY: doc.lastAutoTable.finalY + 14,
      head: [ftHead],
      body: ftBody,
      styles: { font: "helvetica", fontSize: 9, cellPadding: 4 },
      headStyles: { fillColor: [30, 40, 70] },
      theme: "grid",
      margin: { left: 40, right: 40 }
    });

    // Ankle ROM
    const ankHead = ["Ankle ROM (Inability)","Left","Right"];
    const ankBody = ANKLE_ROM.map(r => ([
      r.label,
      getToggleState(`ank__${r.key}__L`) ? "✓" : "",
      getToggleState(`ank__${r.key}__R`) ? "✓" : ""
    ]));

    doc.autoTable({
      startY: doc.lastAutoTable.finalY + 14,
      head: [ankHead],
      body: ankBody,
      styles: { font: "helvetica", fontSize: 9, cellPadding: 4 },
      headStyles: { fillColor: [30, 40, 70] },
      theme: "grid",
      margin: { left: 40, right: 40 }
    });

    // Summary + Notes
    doc.addPage();
    doc.setFont("helvetica", "bold"); doc.setFontSize(13);
    doc.text("Summary", 40, 60);

    doc.setFont("helvetica", "normal"); doc.setFontSize(10);
    const summary = buildSummaryText();
    const sumLines = doc.splitTextToSize(summary, 515);
    doc.text(sumLines, 40, 80);

    const fileBase = ((caseId !== "—" ? caseId : (client !== "—" ? client : "assessment"))).replace(/[^\w\-]+/g, "_");
    doc.save(`${fileBase}_runner_readiness_${new Date().toISOString().slice(0,10)}.pdf`);
  }

  // =========================================================
  // XLSX export
  // =========================================================
  function xlsxExport(){
    const data = collectAll();

    const wb = XLSX.utils.book_new();

    // Sheet 1: Meta
    const metaRows = [
      ["Runner Readiness Assessment"],
      ["Client Name", data.meta.clientName || ""],
      ["Assessment Date", data.meta.assessDate || ""],
      ["Case ID", data.meta.caseId || ""],
      ["Saved At (ISO)", data.meta.savedAtISO || ""]
    ];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(metaRows), "Meta");

    // Sheet 2: Movement
    const mvAoa = [["Metric","Able","Unable","Limitations (if unable)"]];
    MOVEMENT.forEach(m => {
      const able = getToggleState(`mv__${m.key}__able`) ? "Yes" : "";
      const unable = getToggleState(`mv__${m.key}__unable`) ? "Yes" : "";
      const limits = (getToggleState(`mv__${m.key}__unable`) ? (STATE.movementLimits[m.key] || []).join(", ") : "");
      mvAoa.push([m.label, able, unable, limits]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(mvAoa), "Movement");

    // Sheet 3: Strength
    const stAoa = [["Metric","Able (L)","Able (R)","Unable (L)","Unable (R)"]];
    STRENGTH.forEach(it => {
      stAoa.push([
        it.label,
        getToggleState(`st__${it.key}__able__L`) ? "Yes" : "",
        getToggleState(`st__${it.key}__able__R`) ? "Yes" : "",
        getToggleState(`st__${it.key}__unable__L`) ? "Yes" : "",
        getToggleState(`st__${it.key}__unable__R`) ? "Yes" : ""
      ]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(stAoa), "Strength");

    // Sheet 4: Foot
    const ftAoa = [["Metric","Able (L)","Able (R)","Unable (L)","Unable (R)"]];
    FOOT.forEach(it => {
      ftAoa.push([
        it.label,
        getToggleState(`ft__${it.key}__able__L`) ? "Yes" : "",
        getToggleState(`ft__${it.key}__able__R`) ? "Yes" : "",
        getToggleState(`ft__${it.key}__unable__L`) ? "Yes" : "",
        getToggleState(`ft__${it.key}__unable__R`) ? "Yes" : ""
      ]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ftAoa), "Foot");

    // Sheet 5: Ankle ROM
    const ankAoa = [["Motion (Inability)","Left","Right"]];
    ANKLE_ROM.forEach(r => {
      ankAoa.push([
        r.label,
        getToggleState(`ank__${r.key}__L`) ? "Yes" : "",
        getToggleState(`ank__${r.key}__R`) ? "Yes" : ""
      ]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ankAoa), "Ankle ROM");

    // Sheet 6: Notes + Summary
    const nsAoa = [
      ["Coach Notes"],
      [getVal("notes") || ""],
      [],
      ["Auto Summary"],
      [buildSummaryText()]
    ];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(nsAoa), "Notes & Summary");

    const client = data.meta.clientName || "assessment";
    const caseId = data.meta.caseId || "";
    const base = (caseId || client).replace(/[^\w\-]+/g, "_");
    XLSX.writeFile(wb, `${base}_runner_readiness_${new Date().toISOString().slice(0,10)}.xlsx`);
  }

  // =========================================================
  // Wiring
  // =========================================================
  function wire(){
    document.getElementById("btnSave").addEventListener("click", save);
    document.getElementById("btnLoad").addEventListener("click", load);
    document.getElementById("btnPdf").addEventListener("click", pdfExport);
    document.getElementById("btnXlsx").addEventListener("click", xlsxExport);
    document.getElementById("btnPrint").addEventListener("click", () => window.print());
    document.getElementById("btnReset").addEventListener("click", resetAll);

    const autosave = document.getElementById("autosave");
    const autosavePill = document.getElementById("autosavePill");
    autosave.addEventListener("change", () => {
      autosavePill.textContent = `Autosave: ${autosave.checked ? "On" : "Off"}`;
      if(autosave.checked) save();
    });

    document.addEventListener("input", onAnyChange);
  }

  function init(){
    // default date today
    document.getElementById("assessDate").value = new Date().toISOString().slice(0,10);

    // build UI
    buildMovementTable();
    buildLRTable("strengthTable", "st", STRENGTH);
    buildLRTable("footTable", "ft", FOOT);
    buildAnkleBlock();

    // ensure movement chips exist
    MOVEMENT.forEach(m => {
      if(!STATE.movementLimits[m.key]) STATE.movementLimits[m.key] = [];
      refreshLimitChips(m.key);
      setLimitCellEnabled(m.key, false);
    });

    wire();
    onAnyChange();
  }

  init();
</script>
</body>
</html>
